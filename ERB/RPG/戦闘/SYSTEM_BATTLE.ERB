;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;
;	Module		:SYSYTEM_BATTLE.ERB
;	Facility	:ダメージ計算や스테이터스算出などといった전투システムに関わる処理群
;
;	Licence		:ライセンスフリー。
;
;	Modification Data:
;
;	Edit	Date			Author					Reason
;	001		20XX/XX/XX								新規作成
;	002		2011/01/30		P						진・전문내성の処理を추가
;	003		2011/02/06		Rsp暇人					CFLAG:아이템사용능력および아이템사용강화の処理を추가
;	004		2011/03/06		Rsp暇人					CFLAG:아이템사용능력および아이템사용강화の処理を修正。仲魔作成時に초기衣装を설정するように。
;	005		2011/03/28		P						초기호감도の処理を추가。전투員による영매체질によってMAG移動が増加するように변경
;	006		2011/08/31		P						인간がLv80を超えている場合、추가でステ보정が入るように
;	007		2011/11/09		旅人					統合整備
;													ファイルが肥大化している為、ダメージ処理を分離
;	008		2011/05/20		P						반마인がバステ내성を장비からとっていたのを修正
;	009		2012/10/00		(ﾟдﾟ)					푸린키피아に関する記述を추가
;	010		2012/12/02		ネトリス				瀕死になった場合にCFLAG:던전内発情用욕정치が半分になり、発情상태が해제されるように
;	011		2012/12/26		P						식노(데빌시프터)が主人の場合、악마변신時に최대MAGが減ってしまうのを修正
;	012		2013/11/25		ひみつ					NEXT経験値の설정を@GET_NEXT_EXPで行うように(@CHECK_LEVEL_UPの動きに合わせる)
;													現在経験値が1つ下のLVのNEXT経験値より低い場合、その値まで引き上げる(主に加入時の為)
;	013		2013/12/11		ひみつ					NEXT経験値の설정を@GET_NEXT_EXPで行うように(@CHECK_LEVEL_UPの動きに合わせる)
;													現在経験値が1つ下のLVのNEXT経験値より低い場合、その値まで引き上げる(主に加入時の為)
;	014		2015/01/27		Iz						달인강화パッチとして、「무도의마음가짐」「마술의소양」に対応調整
;	015		2015/12/11		JK好き					이능자用の스킬数を確保
;	016		2016/12/11		Jガン					特定のバステで공격が必ず명중するように
;	017		2017/09/23		名無					ガチャモード추가(ガチャ縛り時、非ガチャ産스테이터스반감)
;	018		2018/09/05		sil						相性関係の処理を相性변경複数化用に변경
;	019		2018/10/23		しぐれみそ				장비추가스킬の処理に마정장비用の処理を추가
;	020		2019/03/17		名無					엑스링케이지に伴うムフフでCOOP時 욕정増加
;	021		2019/03/29		名無					ハーモナイザーの処理を추가
;	022		2019/04/12		オレンジスコーン		素質건슬링거がある場合の計算式を추가
;	023		2019/04/27		名無					CSVに특별우정を추가し、특별우정があるとアライメント関係なくCOOP최대になるように
;	024		2019/08/27		空気					장비지식Lv5の보정が重複していた部分を削除、장비지식持ち악마の마법효과・마법위력が장비で上がらないように변경
;	025		2019/08/28		空気					デビルチェンバー사용時の挙動を修正。また、DDMがONなら容量いっぱいでも仲魔になって自動的にストレージに送られるように
;	026		2019/08/30		空気					악마合体時に容量を超えていないのにストレージに送られてしまう問題を修正
;	027		2019/11/27		Jガン					熱り弱点処理を추가
;	028		2019/12/20		Jガン					FLYの스테이터스변경추가
;	029		2020/01/31		131						세대数を스테이터스にボーナス
;	030		2020/02/11		名無し					페르소나구사자の전투스테이터스に페르소나の전투스테이터스に応じた加算
;	031		2020/03/XX		Jガン					무기素質仕様の변경、추가
;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;===============================
;＊重要＊
;能力・相性などの数を指定する
;===============================
@CONFIG_ELEMENT_NUM
;相性の数を指定します
FLAG:相性数 = 18
;기본能力値の数を指定します
FLAG:기본능력수 = 7
;전투能力値の数を指定します
FLAG:전투능력数 = 6
;습득できる스킬の数を指定します
FLAG:스킬数 = 8
;습득できる스킬の数を指定します(이능자달인用)
FLAG:이능자스킬数 = 12
;장비から取得できる추가스킬の数を指定します
FLAG:추가스킬数 = 21
;バッド스테이터스の数を指定します
FLAG:ステート数 = 21




@SYNC_STATUS,ARG
;todo:どう考えてもLCOUNTでやる仕事じゃないのが混じってる　後できちんと変数を변경できたらいいなぁ・・・
#DIM LCOUNT,2
#DIM LSKILL_COUNT
;fixme:したの4つの変数、より説明的な変数名にしようとしたが処理が理解できていないため雑な名づけになっている　いっそTEMP,3とかにしてよかったかもしれないしあるいは処理の内容を再考するべき
#DIM LEQUIP_FIXED_VALUE
#DIM LFIXED_VALUE
#DIM LSUM_OF_BASE
#DIM LMANTRA_FIXED_VALUE
#DIM LFIXED_SUM_OF_BASE
;引数の番号のキャラクターの전투能力等を現在の能力値と同期化
;作業しながら考えてたけど전투能力値弄る人はここも弄るからここ修正する意味薄かった気がする。
;LOCAL:6まで使われていたので、7と8を최대HP・MP記録用として利用

;BASEからMAXBASEを計算しなおす
;조교結果をどう絡めるか思案中
FOR LCOUNT,0,FLAG:기본능력수
	LEQUIP_FIXED_VALUE = 0
	IF CFLAG:ARG:악마변신 == 0
		FOR LCOUNT:1,0,7
			IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
				CALLFORM 기본능력수정_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
			ELSE
				CALLFORM 기본능력수정_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))}, LCOUNT, ARG
			ENDIF
			LEQUIP_FIXED_VALUE += RESULT
		NEXT
	ENDIF
	MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = BASE:ARG:(GET_BASESTATUS(LCOUNT)) + LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LCOUNT)) + "강화횟수")
	;변신済みの데빌시프터・식노は此方	
	IF CFLAG:ARG:악마변신 && LCOUNT > 0
		IF TALENT:ARG:데빌시프터
			SIF LCOUNT == 0
				CONTINUE
			LSUM_OF_BASE = BASE:ARG:힘 + BASE:ARG:지혜 + BASE:ARG:마력 + BASE:ARG:인내력 + BASE:ARG:속도 + BASE:ARG:운
			IF FLAG:데빌시프터ステ설정 == 0
				IF FINDCHARA_ID(CFLAG:ARG:링크악마) > 0
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = LSUM_OF_BASE * BASE:(FINDCHARA_ID(CFLAG:ARG:링크악마)):GET_BASESTATUS(LCOUNT)
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) /= 18 + BASE:(FINDCHARA_ID(CFLAG:ARG:링크악마)):LV * 3 / 2
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LCOUNT)) + "강화횟수")
				ELSE
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = LSUM_OF_BASE * CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LCOUNT)) , 0)
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) /= 18 + CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , "LV") , 0) * 3 / 2
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LCOUNT)) + "강화횟수")
				ENDIF
			ELSE
				IF FINDCHARA_ID(CFLAG:ARG:링크악마) > 0
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = BASE:ARG:(GET_BASESTATUS(LCOUNT)) + LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LCOUNT)) + "강화횟수")
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += BASE:(FINDCHARA_ID(CFLAG:ARG:링크악마)):GET_BASESTATUS(LCOUNT) / 10
				ELSE
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = BASE:ARG:(GET_BASESTATUS(LCOUNT)) + LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LCOUNT)) + "강화횟수")
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += CSVBASE(CFLAG:ARG:초기링크악마, GETNUM(BASE , GET_BASESTATUS(LCOUNT)) , 0) / 5
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += BASE:ARG:LV / 30
				ENDIF
			ENDIF
		;식노 식노は純粋に초기링크악마＋만트라보정の比率に강화込みで振りなおす
		ELSE
			IF LCOUNT == 1
				LMANTRA_FIXED_VALUE = 0
				LFIXED_SUM_OF_BASE = 0
				FOR LOCAL, 1, 7
					LMANTRA_FIXED_VALUE += CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LOCAL)) , 0)
					LMANTRA_FIXED_VALUE += CFLAG:ARG:((GET_BASESTATUS(LOCAL)) + "만트라보정")
					LFIXED_SUM_OF_BASE += BASE:ARG:(GET_BASESTATUS(LOCAL)) + LEQUIP_FIXED_VALUE + CFLAG:ARG:((GET_BASESTATUS(LOCAL)) + "강화횟수")
				NEXT
			ENDIF
			MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = LFIXED_SUM_OF_BASE * (CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LCOUNT)) , 0) + CFLAG:ARG:(GET_BASESTATUS(LCOUNT) + "만트라보정")) / LMANTRA_FIXED_VALUE
			IF LCOUNT == 6
				;分配した스테이터스を無駄なくする
				LMANTRA_FIXED_VALUE = 0
				FOR LOCAL, 1, FLAG:기본능력수
					LOCAL:LOCAL = LOCAL
					LMANTRA_FIXED_VALUE += MAXBASE:ARG:(GET_BASESTATUS(LOCAL))
				NEXT
				;少ないと스테이터스の高い順から増やす
				IF LFIXED_SUM_OF_BASE > LMANTRA_FIXED_VALUE
					FOR LOCAL,1,7
						FOR LCOUNT,LOCAL+1,7
							IF CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LOCAL:LOCAL)) , 0) + CFLAG:ARG:(GET_BASESTATUS(LOCAL:LOCAL) + "만트라보정") < CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LCOUNT)) , 0) + CFLAG:ARG:(GET_BASESTATUS(LCOUNT) + "만트라보정")
								FOR LCOUNT:1,LCOUNT,LOCAL,-1
									SWAP LOCAL:(LCOUNT:1),LOCAL:(LCOUNT:1 - 1)
								NEXT
							ENDIF
						NEXT
					NEXT
					FOR LOCAL,0,LFIXED_SUM_OF_BASE - LMANTRA_FIXED_VALUE
						MAXBASE:ARG:(GET_BASESTATUS(LOCAL:(LOCAL % 6 + 1))) ++
					NEXT
				;多いと스테이터스の低い順から減らす
				ELSEIF LFIXED_SUM_OF_BASE < LMANTRA_FIXED_VALUE
					FOR LOCAL, 1, FLAG:기본능력수
						LOCAL:LOCAL = 7 - LOCAL
					NEXT
					FOR LOCAL,1,7
						FOR LCOUNT,LOCAL+1,7
							IF CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LOCAL:LOCAL)) , 0) + CFLAG:ARG:(GET_BASESTATUS(LOCAL:LOCAL) + "만트라보정") > CSVBASE(CFLAG:ARG:초기링크악마 , GETNUM(BASE , GET_BASESTATUS(LCOUNT)) , 0) + CFLAG:ARG:(GET_BASESTATUS(LCOUNT) + "만트라보정")
								FOR LCOUNT:1,LCOUNT,LOCAL,-1
									SWAP LOCAL:(LCOUNT:1),LOCAL:(LCOUNT:1 - 1)
								NEXT
							ENDIF
						NEXT
					NEXT
					FOR LOCAL,0,LMANTRA_FIXED_VALUE - LFIXED_SUM_OF_BASE
						MAXBASE:ARG:(GET_BASESTATUS(LOCAL:(LOCAL % 6 + 1))) --
					NEXT
				ENDIF
				LCOUNT = 6
			ENDIF
		ENDIF
	ENDIF
	IF ARG == MASTER
		SELECTCASE LCOUNT
			CASE 1,3
				MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += FLAG:今周回음란人数
			CASE 2,5
				MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += FLAG:今周回복종人数
			CASE 4,6
				MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += FLAG:今周回연모人数
		ENDSELECT
		;바・벨修正
		IF EQUIP:ARG:바・벨
			IF FLAG:벨신撃破 & 64
				MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += 5
			ELSE
				SIF LCOUNT && GETBIT(FLAG:벨신撃破, LCOUNT-1)
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += 3
			ENDIF
		ENDIF
	ELSE
		IF 함락(ARG) > 0
			SELECTCASE LCOUNT
				CASE 1,3
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += TALENT:ARG:음란 + TALENT:ARG:창부*2 + 함락(ARG)/2 + TALENT:ARG:음마
				CASE 2,5
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += TALENT:ARG:복종 + TALENT:ARG:예속*2 + 함락(ARG)/2 + TALENT:ARG:노리개
				CASE 4,6
					MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += TALENT:ARG:연모 + TALENT:ARG:친애*2 + 함락(ARG)/2 + (TALENT:ARG:아내 || TALENT:ARG:남편)
			ENDSELECT
		ENDIF
		;허니문&디보스보정
		SIF ABL:ARG:종족 > 0 && LCOUNT > 0
			MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += (EQUIP:MASTER:허니문 && NUM_SUMMONER()) * 함락(ARG) + (EQUIP:MASTER:디보스 && NUM_SUMMONER()) * MARK:ARG:반발각인
	ENDIF
	
	SIF TALENT:ARG:붕괴 && LCOUNT > 0
		TIMES MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) , 0.80
	SIF TALENT:ARG:임신
		MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) += 1
	
	;もろもろ計算で0以下になった場合は1に修正
	SIF MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) < 1
		MAXBASE:ARG:(GET_BASESTATUS(LCOUNT)) = 1
NEXT
;페르소나修正
IF TALENT:ARG:페르소나구사자 && !CFLAG:ARG:악마변신
	LOCAL:7 = MAXBASE:ARG:ＨＰ
	LOCAL:8 = MAXBASE:ARG:ＭＰ
	CALL SYNC_STATUS_P(ARG)
	;ARG = RESULT
ENDIF

;조교効果をここに記述・기본能力
IF ARG != MASTER && CFLAG:ARG:PTフラグ > 0
	MAXBASE:ARG:LV += (MIN(ABL:ARG:순종,10) + MIN(ABL:ARG:욕망,10) + MIN(ABL:ARG:기교,10) +3)/6
	MAXBASE:ARG:힘 += (MIN(ABL:ARG:욕망,10)+1)/2
	MAXBASE:ARG:마력 += (MIN(ABL:ARG:욕망,10)+1)/2
	MAXBASE:ARG:운 += (MIN(ABL:ARG:순종,10)+1)/2
	MAXBASE:ARG:인내력 += (MIN(ABL:ARG:순종,10)+1)/2
	MAXBASE:ARG:지혜 += (MIN(ABL:ARG:기교,10)+1)/2
	MAXBASE:ARG:속도 += (MIN(ABL:ARG:기교,10)+1)/2
ENDIF

;세대数を스테이터스にボーナス
IF ARG != MASTER && CFLAG:ARG:PTフラグ > 0
	MAXBASE:ARG:LV += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:힘 += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:마력 += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:운 += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:인내력 += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:지혜 += (MIN(TALENT:ARG:세대,10))/1
	MAXBASE:ARG:속도 += (MIN(TALENT:ARG:세대,10))/1
ENDIF

;장비추가스킬、現在３つまで설정可能
FOR LCOUNT,1,22
	LOCALS = 장비스킬{LCOUNT}
	ABL:ARG:LOCALS = 0
NEXT
LSKILL_COUNT = 0
FOR LCOUNT:1,0,7
	RESULT = 0
	TRYCALLFORM 장비추가스킬_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},0,ARG
	LOCALS = 장비스킬{LSKILL_COUNT+1}
	LOCAL:9 = RESULT
	IF LOCAL:9 > 0
		ABL:ARG:LOCALS = LOCAL:9
		LSKILL_COUNT += 1
	ENDIF
	RESULT = 0
	TRYCALLFORM 장비추가스킬_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},1,ARG
	LOCALS = 장비스킬{LSKILL_COUNT+1}
	LOCAL:9 = RESULT
	IF LOCAL:9 > 0
		ABL:ARG:LOCALS = LOCAL:9
		LSKILL_COUNT += 1
	ENDIF
	RESULT = 0
	TRYCALLFORM 장비추가스킬_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},2,ARG
	LOCALS = 장비스킬{LSKILL_COUNT+1}
	LOCAL:9 = RESULT
	IF LOCAL:9 > 0
		ABL:ARG:LOCALS = LOCAL:9
		LSKILL_COUNT += 1
	ENDIF
	;-----------마정장비추가스킬ここから-----------
	IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
		RESULT = 0
		TRYCALLFORM 장비추가스킬_마정장비,0,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
		LOCALS = 장비스킬{LSKILL_COUNT+1}
		LOCAL:9 = RESULT
		IF LOCAL:9 > 0
			ABL:ARG:LOCALS = LOCAL:9
			LSKILL_COUNT += 1
		ENDIF
		RESULT = 0
		TRYCALLFORM 장비추가스킬_마정장비,1,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
		LOCALS = 장비스킬{LSKILL_COUNT+1}
		LOCAL:9 = RESULT
		IF LOCAL:9 > 0
			ABL:ARG:LOCALS = LOCAL:9
			LSKILL_COUNT += 1
		ENDIF
		RESULT = 0
		TRYCALLFORM 장비추가스킬_마정장비,2,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
		LOCALS = 장비스킬{LSKILL_COUNT+1}
		LOCAL:9 = RESULT
		IF LOCAL:9 > 0
			ABL:ARG:LOCALS = LOCAL:9
			LSKILL_COUNT += 1
		ENDIF
	ENDIF
	;-----------마정장비추가스킬ここまで-----------
NEXT

;인수라のみ、습득스킬추가
IF TALENT:ARG:인수라
	LSKILL_COUNT = 0
	FOR LCOUNT:1,0,20
		RESULT = 0
		TRYCALLFORM P습득스킬_{EQUIP:ARG:(GET_EQUIP(6))},LCOUNT:1
		LOCAL:9 = RESULT
		LOCAL:10 = RESULT:1
		LOCALS = 습득스킬{LSKILL_COUNT+1}
		LOCALS:2 = 습득LV{LSKILL_COUNT+1}
		;장비品に습득스킬&LVが存在してて、かつ습득経験が無いことが조건
		IF LOCAL:9 > 0 && LOCAL:10 > 0 && !(CDFLAG:ARG:((EQUIP:ARG:(GET_EQUIP(6)))%5+1):((EQUIP:ARG:(GET_EQUIP(6))-8000)/5) & POWER(2,LCOUNT:1))
			ABL:ARG:LOCALS = LOCAL:9
			ABL:ARG:(LOCALS:2) = LOCAL:10
			LSKILL_COUNT += 1
		ELSE
			ABL:ARG:LOCALS = 0
			ABL:ARG:(LOCALS:2) = 0
			LSKILL_COUNT += 1
		ENDIF
	NEXT
ENDIF

;---- EDIT 029 MOD START -------------------------
;무기素質　一ノ型パラメータ보정
CALL MATCHING_WEAPON_CHECK(ARG)
LCOUNT = RESULT
CALL WEAPON_STYLE_CHECK(ARG,LCOUNT)
IF RESULT == 1
	RESULT = 0
	TRYCALLFORM 필요레벨_{EQUIP:ARG:검}
	RESULT = MIN(RESULT , 100)
	RESULT = RESULT/2 + MIN(RESULT%2 , 1)
	SELECTCASE LCOUNT
		CASE 1
			MAXBASE:ARG:힘 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:운 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 2
			MAXBASE:ARG:지혜 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:운 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 3
			MAXBASE:ARG:힘 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:마력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 4
			MAXBASE:ARG:힘 += RESULT/4 + MIN(RESULT%4 , 1)
			MAXBASE:ARG:인내력 += RESULT/4 + MIN(RESULT%4 , 1)
			MAXBASE:ARG:속도 += RESULT/4 + MIN(RESULT%4 , 1)
			MAXBASE:ARG:운 += RESULT/4 + MIN(RESULT%4 , 1)
		CASE 5
			MAXBASE:ARG:힘 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:인내력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:운 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 6
			MAXBASE:ARG:힘 += RESULT/2 + MIN(RESULT%2 , 1)
			MAXBASE:ARG:인내력 += RESULT/2 + MIN(RESULT%2 , 1)
		CASE 7
			MAXBASE:ARG:지혜 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:마력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:인내력 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 8
			MAXBASE:ARG:지혜 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:마력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 9
			MAXBASE:ARG:지혜 += RESULT/2 + MIN(RESULT%2 , 1)
			MAXBASE:ARG:마력 += RESULT/2 + MIN(RESULT%2 , 1)
		CASE 10
			MAXBASE:ARG:지혜 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:인내력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
		CASE 11
			MAXBASE:ARG:힘 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:인내력 += RESULT/3 + MIN(RESULT%3 , 1)
			MAXBASE:ARG:속도 += RESULT/3 + MIN(RESULT%3 , 1)
	ENDSELECT
ENDIF
;---- EDIT 029 MOD END ---------------------------
;MAXBASEをそれぞれのLOCALに代入
FOR LCOUNT,0,FLAG:기본능력수
	LOCAL:(LCOUNT) = MAXBASE:ARG:(GET_BASESTATUS(LCOUNT))
;---- EDIT 028 MOD START -------------------------
;FLY상태で속도、레벨以外パラメータ11
	SIF GET_STATE(CFLAG:ARG:ステート) == "FLY" && (LCOUNT != 0 || LCOUNT != 5)
		LOCAL:(LCOUNT) = 1
;---- EDIT 028 MOD END ---------------------------
;---- EDIT 028 MOD START -------------------------
;---- EDIT 028 MOD END ---------------------------
NEXT


IF (ABL:ARG:종족 == 0 || ABL:ARG:종족 == 36) && CFLAG:ARG:악마변신 == 0
	;HP
	MAXBASE:ARG:ＨＰ = (LOCAL+LOCAL:1*2+LOCAL:4*7+5)*(100+LOCAL*3)/100
	SIF CFLAG:ARG:PTフラグ == 0 && ! CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＨＰ = (LOCAL*3+LOCAL:1*2+LOCAL:4*9/2+5)*(100+LOCAL*3)/100
	SIF CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＨＰ *= 4+(CFLAG:ARG:ボスフラグ)
	SIF CFLAG:ARG:PTフラグ == 0 && FLAG:전투난이도 > 3
		TIMES MAXBASE:ARG:ＨＰ , 1.50
	IF HAVE_SKILL(ARG,[[스킬:무도의마음가짐]]) > 0
	    TIMES MAXBASE:ARG:ＨＰ,1.60
	ELSEIF HAVE_SKILL(ARG,[[스킬:삼할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.30
	ELSEIF HAVE_SKILL(ARG,[[스킬:이할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.20
	ELSEIF HAVE_SKILL(ARG,[[스킬:일할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.10
	ELSEIF HAVE_SKILL(ARG,[[스킬:네버기브업]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.30
	ENDIF
	MAXBASE:ARG:ＨＰ += CFLAG:ARG:ＨＰ보정
	
	;MP
	MAXBASE:ARG:ＭＰ = 0
	SIF TALENT:ARG:이능자 || TALENT:ARG:달인 || TALENT:ARG:페르소나구사자 || TALENT:ARG:데빌시프터 || TALENT:ARG:식노 || TALENT:ARG:악마빙의자 || ABL:ARG:종족 == 36 
		MAXBASE:ARG:ＭＰ = ((LOCAL+LOCAL:2/2+(LOCAL:3*3/2))*2 + 5) * (100+LOCAL)/100
	SIF CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＭＰ *= 4+(CFLAG:ARG:ボスフラグ)
	IF HAVE_SKILL(ARG,[[스킬:마술의소양]]) > 0
	    TIMES MAXBASE:ARG:ＭＰ,1.60
	ELSEIF HAVE_SKILL(ARG,[[스킬:삼할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.30
	ELSEIF HAVE_SKILL(ARG,[[스킬:이할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.20
	ELSEIF HAVE_SKILL(ARG,[[스킬:일할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.10
	ELSEIF HAVE_SKILL(ARG,[[스킬:네버기브업]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.30
	ENDIF
	MAXBASE:ARG:ＭＰ += CFLAG:ARG:ＭＰ보정
	IF FLAG:인간전투ステ설정 == 2
		;공격
		BASE:ARG:(GET_BATTLESTATUS(0)) = (LOCAL/2+LOCAL:1*5/2+LOCAL:4) + CFLAG:ARG:공격보정
		;명중
		BASE:ARG:(GET_BATTLESTATUS(1)) = (LOCAL+LOCAL:5*5/2+LOCAL:6) + CFLAG:ARG:명중보정
		;방어
		BASE:ARG:(GET_BATTLESTATUS(2)) = (LOCAL+LOCAL:4*3+(LOCAL:1)/2) + CFLAG:ARG:방어보정
		;회피
		BASE:ARG:(GET_BATTLESTATUS(3)) = (LOCAL+LOCAL:5*5/2+LOCAL:6) + CFLAG:ARG:회피보정
		;마법위력
		BASE:ARG:(GET_BATTLESTATUS(4)) = (LOCAL/2+LOCAL:3*5/2+LOCAL:2) + CFLAG:ARG:마법위력보정
		;마법효과
		BASE:ARG:(GET_BATTLESTATUS(5)) = (LOCAL+LOCAL:2*2+LOCAL:6+LOCAL:3/2) + CFLAG:ARG:마법효과보정
	ELSE
		;공격
		BASE:ARG:(GET_BATTLESTATUS(0)) = (LOCAL/2+LOCAL:1+LOCAL:4/2) + CFLAG:ARG:공격보정
		;명중
		BASE:ARG:(GET_BATTLESTATUS(1)) = (LOCAL+LOCAL:5+LOCAL:6/2) + CFLAG:ARG:명중보정
		;방어
		BASE:ARG:(GET_BATTLESTATUS(2)) = (LOCAL+LOCAL:4) + CFLAG:ARG:방어보정
		;회피
		BASE:ARG:(GET_BATTLESTATUS(3)) = (LOCAL+LOCAL:5+LOCAL:6/2) + CFLAG:ARG:회피보정
		;마법위력
		BASE:ARG:(GET_BATTLESTATUS(4)) = (LOCAL/2+LOCAL:3+LOCAL:2/2) + CFLAG:ARG:마법위력보정
		;마법효과
		BASE:ARG:(GET_BATTLESTATUS(5)) = (LOCAL+LOCAL:2+LOCAL:6/2) + CFLAG:ARG:마법효과보정
		IF FLAG:인간전투ステ설정 == 1
			;명중
			BASE:ARG:(GET_BATTLESTATUS(1)) = (LOCAL+LOCAL:5*5/2+LOCAL:6) + CFLAG:ARG:명중보정
			;마법효과
			BASE:ARG:(GET_BATTLESTATUS(5)) = (LOCAL+LOCAL:2*2+LOCAL:6+LOCAL:3/2) + CFLAG:ARG:마법효과보정
		ENDIF
	ENDIF
	;총명중
	IF TALENT:ARG:건슬링거 == 1
		BASE:ARG:총명중 = (LOCAL+LOCAL:5+LOCAL:6+LOCAL:2) + CFLAG:ARG:총명중보정
	ELSE
		BASE:ARG:총명중 = (LOCAL+LOCAL:5/2+LOCAL:6/2+LOCAL:2/2) + CFLAG:ARG:총명중보정
	ENDIF
	;총공격
	IF TALENT:ARG:건슬링거 == 1
		BASE:ARG:총공격 = (LOCAL + LOCAL:2/2 + LOCAL:5/2) + CFLAG:ARG:총공격보정
	ELSE
		BASE:ARG:총공격 = (LOCAL/2 + LOCAL:2/4 + LOCAL:5/4) + CFLAG:ARG:총공격보정
	ENDIF
	;ソフトハーモナイザーで기본능력강화
	IF EQUIP:MASTER:하모나이저 && GET_SUMMONER_LV2() > 2 && CFLAG:ARG:PTフラグ > 0
		;공격
		BASE:ARG:(GET_BATTLESTATUS(0)) += (LOCAL*3/2+LOCAL:1*3/2+LOCAL:4*1/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
		;명중
		BASE:ARG:(GET_BATTLESTATUS(1)) += (LOCAL+LOCAL:5*3/2+LOCAL:6*1/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
		;방어
		BASE:ARG:(GET_BATTLESTATUS(2)) += (LOCAL+LOCAL:4*2+(LOCAL:1)/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
		;회피
		BASE:ARG:(GET_BATTLESTATUS(3)) += (LOCAL+LOCAL:5*3/2+LOCAL:6*1/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
		;마법위력
		BASE:ARG:(GET_BATTLESTATUS(4)) += (LOCAL*3/2+LOCAL:3*3/2+LOCAL:2*1/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
		;마법효과
		BASE:ARG:(GET_BATTLESTATUS(5)) += (LOCAL+LOCAL:2+LOCAL:6/2+LOCAL:3/2) * MIN((GET_SUMMONER_LV2()-2)*2,6) * 10 / 100
	ENDIF
	;LVが80を超えている場合、장비部分に相当する보정を추가で与える
	IF BASE:ARG:LV > 80 && CFLAG:ARG:장비보정변경횟수 > 0 && EQUIP:ARG:검 != [[아이템:리빙・엣지]]
		;공격
		BASE:ARG:(GET_BATTLESTATUS(0)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1040 / 4
		;명중
		BASE:ARG:(GET_BATTLESTATUS(1)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1041 / 4
		;방어
		BASE:ARG:(GET_BATTLESTATUS(2)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1042 / 4
		;회피
		BASE:ARG:(GET_BATTLESTATUS(3)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1043 / 4
		;마법위력
		BASE:ARG:(GET_BATTLESTATUS(4)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1044 / 4
		;마법효과
		BASE:ARG:(GET_BATTLESTATUS(5)) += (BASE:ARG:LV - 80) * CFLAG:ARG:1045 / 4
		;총공격
		BASE:ARG:총공격 += (BASE:ARG:LV - 80) * CFLAG:ARG:1046 / 4
		;총명중
		BASE:ARG:총명중 += (BASE:ARG:LV - 80) * CFLAG:ARG:1047 / 4
	ELSEIF BASE:ARG:LV > 80 && EQUIP:ARG:검 != [[아이템:리빙・엣지]]
		;공격
		BASE:ARG:(GET_BATTLESTATUS(0)) += (BASE:ARG:LV - 80) * 9 / 4
		;명중
		BASE:ARG:(GET_BATTLESTATUS(1)) += (BASE:ARG:LV - 80) * 7 / 4
		;방어
		BASE:ARG:(GET_BATTLESTATUS(2)) += (BASE:ARG:LV - 80) * 11 / 4
		;회피
		BASE:ARG:(GET_BATTLESTATUS(3)) += (BASE:ARG:LV - 80) * 7 / 4
		;마법위력
		BASE:ARG:(GET_BATTLESTATUS(4)) += (BASE:ARG:LV - 80) * 9 / 4
		;마법효과
		BASE:ARG:(GET_BATTLESTATUS(5)) +=(BASE:ARG:LV - 80) * 7 / 4
		;총명중
		BASE:ARG:총명중 += (BASE:ARG:LV - 80) * 7 / 4
		;총공격
		BASE:ARG:총공격 += (BASE:ARG:LV - 80) * 9 / 4
	ENDIF
	
;---- EDIT 028 ADD START -------------------------
	SIF TALENT:ARG:페르소나구사자
		CALL 페르소나구사자전투스테이터스강화パッチ(ARG)
;---- EDIT 028 ADD END-- -------------------------

	;장비品の보정
	FOR LCOUNT,0,FLAG:전투능력数
		LEQUIP_FIXED_VALUE = 0
		FOR LCOUNT:1,0,7
			IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
				CALLFORM 전투능력수정_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
			ELSE
				CALLFORM 전투능력수정_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},LCOUNT,ARG
				CALL 장비강화_전개, ARG, EQUIP:ARG:GET_EQUIP(LCOUNT:1), "전투능력수정", GET_BATTLESTATUS(LCOUNT), RESULT
			ENDIF
			LFIXED_VALUE = RESULT
;---- EDIT 024 DEL START -------------------------
;			SIF HAVE_SKILL(ARG, 2443)
;				TIMES LFIXED_VALUE,1.25
;---- EDIT 024 DEL END-- -------------------------
			IF LCOUNT:1 == 0
				TRYCCALLFORM 검타입_{EQUIP:ARG:GET_EQUIP(LCOUNT:1)}
					IF RESULT > 0
						;---- EDIT 029 MOD
						SIF TALENT:ARG:(249 + RESULT) && LFIXED_VALUE > 0
							TIMES LFIXED_VALUE,1.10
						SIF TALENT:ARG:(249 + RESULT) && LFIXED_VALUE < 0
							TIMES LFIXED_VALUE,0.50
					ENDIF
				CATCH
				ENDCATCH
			ENDIF
			IF BASE:ARG:LV > 100
				TRYCCALLFORM 필요레벨_{EQUIP:ARG:GET_EQUIP(LCOUNT:1)}
					SIF RESULT > 69
						LFIXED_VALUE = LFIXED_VALUE * BASE:ARG:LV / 100
				CATCH
				ENDCATCH
			ENDIF
			LEQUIP_FIXED_VALUE += LFIXED_VALUE
		NEXT
			IF FLAG:인간전투ステ설정 == 3 && (TALENT:ARG:이능자 || TALENT:ARG:달인 || ABL:ARG:종족 == 0 || ABL:ARG:종족 == 36)
				IF SKILL_EQUIPTHEORY_IS_HAVE_SKILL(ARG)
					MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, LEQUIP_FIXED_VALUE)
				ELSE
					MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + LEQUIP_FIXED_VALUE * (100 + (BASE:ARG:LV/2)) / 100
				ENDIF
			ELSE
				IF SKILL_EQUIPTHEORY_IS_HAVE_SKILL(ARG)
					MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, LEQUIP_FIXED_VALUE)
				ELSE
					MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + LEQUIP_FIXED_VALUE
				ENDIF
			ENDIF
	NEXT

	FOR LCOUNT,0,FLAG:相性数
		SIF TALENT:ARG:비전투원 && LCOUNT != 10
			BASE:ARG:GET_TYPE(LCOUNT) = 100
		SIF TALENT:ARG:비전투원 && LCOUNT == 10
			BASE:ARG:GET_TYPE(LCOUNT) = 0
		;페르소나구사자はすでに내성変化を終えてるのでBREAK
		SIF TALENT:ARG:페르소나구사자
			BREAK
		;반마인は장비の影響を受けずに相性변경の影響を受ける
		IF ABL:ARG:종족 == 36
			MAXBASE:ARG:GET_TYPE(LCOUNT)  = CFLAG:ARG:변경相性1 == LCOUNT + 1 ? CFLAG:ARG:변경相性치1 # BASE:ARG:GET_TYPE(LCOUNT)
			CONTINUE
		ENDIF
		VARSET T,-1
		FOR LCOUNT:1,0,7
			IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
				CALLFORM 방어상성_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
				T:(LCOUNT:1) = RESULT
			ELSE
				CALLFORM 방어상성_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},LCOUNT,ARG
				CALL 장비강화_전개, ARG, EQUIP:ARG:GET_EQUIP(LCOUNT:1), "방어상성", GET_TYPE(LCOUNT), RESULT
				T:(LCOUNT:1) = RESULT
			ENDIF
		NEXT
		T:7 = BASE:ARG:(GET_TYPE(LCOUNT))
		IF T:7 < 100 || T:7 == 999
			IF MINARRAY(T,0,7) < 100
				IF MAXARRAY(T,0,7) > 100
					MAXBASE:ARG:(GET_TYPE(LCOUNT)) = MINARRAY(T,0,7)
					SIF MAXBASE:ARG:(GET_TYPE(LCOUNT)) > -1 && MATCH(T,999,0,7)
						MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 999
				ELSE
					MAXBASE:ARG:(GET_TYPE(LCOUNT)) = MINARRAY(T,0,8)
					SIF MAXBASE:ARG:(GET_TYPE(LCOUNT)) > -1 && MATCH(T,999,0,8)
						MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 999
				ENDIF
			ELSEIF MAXARRAY(T,0,7) > 100
				MAXBASE:ARG:(GET_TYPE(LCOUNT)) = MAXARRAY(T,0,7)
				SIF MAXBASE:ARG:(GET_TYPE(LCOUNT)) > -1 && MATCH(T,999,0,7)
					MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 999
			
			ELSE
				MAXBASE:ARG:(GET_TYPE(LCOUNT)) = T:7
				SIF MAXBASE:ARG:(GET_TYPE(LCOUNT)) > -1 && MATCH(T,999,0,8)
					MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 999
			ENDIF
		ELSE
			MAXBASE:ARG:(GET_TYPE(LCOUNT)) = MINARRAY(T,0,8)
			IF MAXBASE:ARG:(GET_TYPE(LCOUNT)) < 100
			ELSE
				MAXBASE:ARG:(GET_TYPE(LCOUNT)) = MAXARRAY(T,0,8)
			ENDIF
			SIF MAXBASE:ARG:(GET_TYPE(LCOUNT)) > -1 && MATCH(T,999,0,8)
				MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 999
		ENDIF
	NEXT
	
	FOR LCOUNT,0,FLAG:ステート数
		VARSET T,-1
		;장비効果설정が通常の場合、P3型を除く페르소나구사자はバステ내성변경がない
		SIF (BATTLE_SETTING_IS_EQUIPTHEORY() && TALENT:ARG:페르소나구사자 == 1) || (BATTLE_SETTING_IS_EQUIPTHEORY() && TALENT:ARG:페르소나구사자 >= 1 && FLAG:페르소나구사자仕様설정 == 1)
			BREAK
		;반마인は元々のバステ내성をみる
		IF ABL:ARG:종족 == 36
			MAXBASE:ARG:(GET_STATE(LCOUNT)) = BASE:ARG:(GET_STATE(LCOUNT))
			CONTINUE
		ENDIF
		FOR LCOUNT:1,0,7
			IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
				RESULT = 0
				TRYCALLFORM バステ내성_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
				T:(LCOUNT:1) = RESULT
			ELSE
				RESULT = 0
				TRYCALLFORM バステ내성_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},LCOUNT,ARG
				T:(LCOUNT:1) = RESULT
			ENDIF
		NEXT
		T:7 = BASE:ARG:(GET_STATE(LCOUNT))
		
		IF T:7 < 0
			IF MINARRAY(T,0,7) < 0
				IF MAXARRAY(T,0,7) > 0
					MAXBASE:ARG:(GET_STATE(LCOUNT)) = MINARRAY(T,0,7)
				ELSE
					MAXBASE:ARG:(GET_STATE(LCOUNT)) = MINARRAY(T,0,8)
				ENDIF
			ELSEIF MAXARRAY(T,0,7) > 0
				MAXBASE:ARG:(GET_STATE(LCOUNT)) = MAXARRAY(T,0,7)
			ELSE
				MAXBASE:ARG:(GET_STATE(LCOUNT)) = T:7
			ENDIF
		ELSE
			MAXBASE:ARG:(GET_STATE(LCOUNT)) = MINARRAY(T,0,8)
			IF MAXBASE:ARG:(GET_STATE(LCOUNT)) < 0
			ELSE
				MAXBASE:ARG:(GET_STATE(LCOUNT)) = MAXARRAY(T,0,8)
			ENDIF
		ENDIF
	NEXT
	
	
	
	IF 마정장비(EQUIP:ARG:검)
		CALLFORM 공격상성_마정장비,EQUIP:ARG:검-2450
		ABL:ARG:공격상성 = RESULT
		CALLFORM 사거리_마정장비,EQUIP:ARG:검-2450
		ABL:ARG:사거리 = RESULT
		CALLFORM 최저공격횟수_마정장비,EQUIP:ARG:검-2450
		ABL:ARG:최저공격횟수 = RESULT
		CALLFORM 최대공격횟수_마정장비,EQUIP:ARG:검-2450
		ABL:ARG:최대공격횟수 = RESULT
		CALLFORM 공격범위_마정장비,EQUIP:ARG:검-2450
		ABL:ARG:공격범위 = RESULT
		TRYCCALLFORM 추가효과_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:추가효과 = RESULT
			CALLFORM 추가효과상성_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:추가효과상성 = RESULT
			CALLFORM 추가효과명중률_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:추가효과명중률 = RESULT
			CALLFORM 추가효과최대명중률_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:추가효과최대명중률 = RESULT
		CATCH
			ABL:ARG:추가효과 = 0
			ABL:ARG:추가효과상성 = 0
			ABL:ARG:추가효과명중률 = 0
			ABL:ARG:추가효과최대명중률 = 0
		ENDCATCH
	ELSE
		CALLFORM 공격상성_{EQUIP:ARG:검},ARG
		ABL:ARG:공격상성 = RESULT
		CALLFORM 사거리_{EQUIP:ARG:검},ARG
		ABL:ARG:사거리 = RESULT
		CALLFORM 최저공격횟수_{EQUIP:ARG:검},ARG
		ABL:ARG:최저공격횟수 = RESULT
		CALLFORM 최대공격횟수_{EQUIP:ARG:검},ARG
		ABL:ARG:최대공격횟수 = RESULT
		CALLFORM 공격범위_{EQUIP:ARG:검},ARG
		ABL:ARG:공격범위 = RESULT
		TRYCCALLFORM 추가효과_{EQUIP:ARG:검},ARG
			IF GET_STATE(RESULT) == "GOOD" 
				CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "ステート"
				IF GET_STATE(RESULT) != "GOOD"
					ABL:ARG:추가효과 = RESULT
					CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "効果相性"
					ABL:ARG:추가효과상성 = RESULT
					CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "기본명중"
					ABL:ARG:추가효과명중률 = RESULT
					CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "최대명중"
					ABL:ARG:추가효과최대명중률 = RESULT
				ELSE
					ABL:ARG:추가효과 = 0
					ABL:ARG:추가효과상성 = 0
					ABL:ARG:추가효과명중률 = 0
					ABL:ARG:추가효과최대명중률 = 0
				ENDIF
			ELSE
				ABL:ARG:추가효과 = RESULT
				CALLFORM 추가효과상성_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과상성 = RESULT
				CALLFORM 추가효과명중률_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과명중률 = RESULT
				CALLFORM 추가효과최대명중률_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과최대명중률 = RESULT
			ENDIF
		CATCH
			CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "ステート"
			IF GET_STATE(RESULT) != "GOOD"
				ABL:ARG:추가효과 = RESULT
				CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "効果相性"
				ABL:ARG:추가효과상성 = RESULT
				CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "기본명중"
				ABL:ARG:추가효과명중률 = RESULT
				CALL 장비강화_전개, ARG, EQUIP:ARG:검, "추가효과", "최대명중"
				ABL:ARG:추가효과최대명중률 = RESULT
			ELSE
				ABL:ARG:추가효과 = 0
				ABL:ARG:추가효과상성 = 0
				ABL:ARG:추가효과명중률 = 0
				ABL:ARG:추가효과최대명중률 = 0
			ENDIF
		ENDCATCH
	ENDIF

	IF EQUIP:ARG:총 > 0
		IF 마정장비(EQUIP:ARG:총)
			CALLFORM 총명중_마정장비,EQUIP:ARG:총-2900
			MAXBASE:ARG:총명중 = BASE:ARG:총명중 + RESULT
			CALLFORM 총공격_마정장비,EQUIP:ARG:총-2900
			MAXBASE:ARG:총공격 = BASE:ARG:총공격 + RESULT
		ELSE
			LFIXED_VALUE = 100
			IF BASE:ARG:LV > 100
				TRYCCALLFORM 필요레벨_{EQUIP:ARG:총}
					SIF RESULT > 69
						LFIXED_VALUE = BASE:ARG:LV
				CATCH
				ENDCATCH
			ENDIF
			CALLFORM 총명중_{EQUIP:ARG:총},ARG
			CALL 장비강화_전개, ARG, EQUIP:ARG:총, "전투능력수정", "총명중", RESULT
			MAXBASE:ARG:총명중 = BASE:ARG:총명중 + (RESULT * LFIXED_VALUE/100)
			CALLFORM 총공격_{EQUIP:ARG:총},ARG
			CALL 장비강화_전개, ARG, EQUIP:ARG:총, "전투능력수정", "총공격", RESULT
			MAXBASE:ARG:총공격 = BASE:ARG:총공격 + (RESULT * LFIXED_VALUE/100)
		ENDIF
		
	ELSE
		MAXBASE:ARG:총명중 = 0
		MAXBASE:ARG:총공격 = 0
	ENDIF

	;조교効果をここに記述・전투能力
	IF ARG != MASTER && CFLAG:ARG:PTフラグ > 0
		;現状処理なし
	ENDIF

	;NEXT経験値
	;MAXBASE:ARG:ＥＸＰ  = 5*(BASE:ARG:LV)*(BASE:ARG:LV+1)*(BASE:ARG:LV+2)/3
	MAXBASE:ARG:ＥＸＰ = GET_NEXT_EXP(BASE:ARG:LV, ABL:ARG:종족 && !함락(ARG))
	BASE:ARG:ＥＸＰ = MAX(BASE:ARG:ＥＸＰ, GET_NEXT_EXP(BASE:ARG:LV - 1, ABL:ARG:종족 && !함락(ARG)))
	
	;ＭＡＧ
	IF ARG == MASTER
		MAXBASE:ARG:ＭＡＧ  = (75)*(LOCAL)*(LOCAL+1)*(LOCAL+2)
	ELSE
		MAXBASE:ARG:ＭＡＧ  = (15+함락(ARG)*3)*(LOCAL)*(LOCAL+1)*(LOCAL+2)
	ENDIF
	
	;抗体ポイント
	IF CSVBASE(NO:ARG,GETNUM(BASE,"CP"),0) != 0 && CFLAG:ARG:PTフラグ > 0
		 LOCAL:1 = 15
		 FOR LOCAL,0,FLAG:相性数 +1
		 	SELECTCASE MAXBASE:ARG:(GET_TYPE(LOCAL))
		 		CASE 999
		 			LOCAL:1 += 55
		 		CASE IS < 0
		 			LOCAL:1 += 55
		 		CASE 0
		 			LOCAL:1 += 40
		 		CASE IS > 199
		 			LOCAL:1 -= 25
		 		CASE IS > 100
		 			LOCAL:1 -= 15
		 		CASE IS <= 50
		 			LOCAL:1 += 25
		 		CASE IS < 100
		 			LOCAL:1 += 15
		 	ENDSELECT
		 NEXT
		BASE:ARG:CP = MAX(1,LOCAL:1/2) + CFLAG:ARG:ＣＰ보정
		MAXBASE:ARG:CP = MAX(1,BASE:ARG:CP * MAXBASE:ARG:LV / 50 * (100-MIN(10000,BASE:ARG:충성도)*50/10000) / 100)
		MAXBASE:ARG:￥ = MAX(1,BASE:ARG:CP * MAXBASE:ARG:LV * (100-MIN(5000,BASE:ARG:충성도)*90/5000) / 100)
	ELSE
		MAXBASE:ARG:CP = BASE:ARG:CP * MAXBASE:ARG:LV / 50
		MAXBASE:ARG:￥ = 0
	ENDIF

ELSE
;악마の場合

	;HP
	MAXBASE:ARG:ＨＰ = (LOCAL+LOCAL:1*2+LOCAL:4*7+5)*(100+LOCAL*3)/100
	SIF CFLAG:ARG:PTフラグ == 0 && ! CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＨＰ = (LOCAL*3+LOCAL:1*2+LOCAL:4*9/2+5)*(100+LOCAL*3)/100
	SIF CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＨＰ *= 5+CFLAG:ARG:ボスフラグ
	SIF CFLAG:ARG:PTフラグ == 0 && FLAG:전투난이도 > 3
		TIMES MAXBASE:ARG:ＨＰ , 1.50
	IF HAVE_SKILL(ARG,[[스킬:무도의마음가짐]]) > 0
	    TIMES MAXBASE:ARG:ＨＰ,1.60
	ELSEIF HAVE_SKILL(ARG,[[스킬:삼할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.30
	ELSEIF HAVE_SKILL(ARG,[[스킬:이할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.20
	ELSEIF HAVE_SKILL(ARG,[[스킬:일할의활천]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.10
	ELSEIF HAVE_SKILL(ARG,[[스킬:네버기브업]]) > 0
		TIMES MAXBASE:ARG:ＨＰ,1.30
	ENDIF
	MAXBASE:ARG:ＨＰ += CFLAG:ARG:ＨＰ보정

	;MP
	MAXBASE:ARG:ＭＰ = ((LOCAL+LOCAL:2/2+(LOCAL:3*3/2))*2 + 5) * (100+LOCAL)/100
	SIF CFLAG:ARG:ボスフラグ
		MAXBASE:ARG:ＭＰ *= 5+CFLAG:ARG:ボスフラグ
	IF HAVE_SKILL(ARG,[[스킬:마술의소양]]) > 0
	    TIMES MAXBASE:ARG:ＭＰ,1.60
	ELSEIF HAVE_SKILL(ARG,[[스킬:삼할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.30
	ELSEIF HAVE_SKILL(ARG,[[스킬:이할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.20
	ELSEIF HAVE_SKILL(ARG,[[스킬:일할의마맥]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.10
	ELSEIF HAVE_SKILL(ARG,[[스킬:네버기브업]]) > 0
		TIMES MAXBASE:ARG:ＭＰ,1.30
	ENDIF
	MAXBASE:ARG:ＭＰ += CFLAG:ARG:ＭＰ보정

	;공격
	BASE:ARG:(GET_BATTLESTATUS(0)) = (LOCAL*2+LOCAL:1*5/2+LOCAL:4) + CFLAG:ARG:공격보정
	;명중
	BASE:ARG:(GET_BATTLESTATUS(1)) = (LOCAL*2+LOCAL:5*5/2+LOCAL:6) + CFLAG:ARG:명중보정
	;방어
	BASE:ARG:(GET_BATTLESTATUS(2)) = (LOCAL*2+LOCAL:4*3+(LOCAL:1)/2) + CFLAG:ARG:방어보정
	;회피
	BASE:ARG:(GET_BATTLESTATUS(3)) = (LOCAL*2+LOCAL:5*5/2+LOCAL:6) + CFLAG:ARG:회피보정
	;마법위력
	BASE:ARG:(GET_BATTLESTATUS(4)) = (LOCAL*2+LOCAL:3*5/2+LOCAL:2) + CFLAG:ARG:마법위력보정
	;마법효과
	BASE:ARG:(GET_BATTLESTATUS(5)) = (LOCAL*2+LOCAL:2*2+LOCAL:6+LOCAL:3/2) + CFLAG:ARG:마법효과보정
	FOR LCOUNT, 0, 6
		MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT))
	NEXT
	
	;장비지식스킬持ちならここで処理
	IF SKILL_EQUIPTHEORY_IS_HAVE_SKILL(ARG)
		;총명중
		IF TALENT:ARG:건슬링거 == 1
			BASE:ARG:총명중 = (LOCAL+LOCAL:5+LOCAL:6+LOCAL:2) + CFLAG:ARG:총명중보정
		ELSE
			BASE:ARG:총명중 = (LOCAL+LOCAL:5/2+LOCAL:6/2+LOCAL:2/2) + CFLAG:ARG:총명중보정
		ENDIF
		;총공격
		IF TALENT:ARG:건슬링거 == 1
			BASE:ARG:총공격 = (LOCAL + LOCAL:2/2 + LOCAL:5/2) + CFLAG:ARG:총공격보정
		ELSE
			BASE:ARG:총공격 = (LOCAL/2 + LOCAL:2/4 + LOCAL:5/4) + CFLAG:ARG:총공격보정
		ENDIF
		;LVが80を超えている場合、장비部分に相当する보정を추가で与える
		IF BASE:ARG:LV > 80
			;장비効果설정が通常の場合影響あり
			IF BATTLE_SETTING_IS_EQUIPTHEORY() == 0
				;공격
				BASE:ARG:(GET_BATTLESTATUS(0)) += (BASE:ARG:LV - 80) * 9 / 4
				;명중
				BASE:ARG:(GET_BATTLESTATUS(1)) += (BASE:ARG:LV - 80) * 7 / 4
				;방어
				BASE:ARG:(GET_BATTLESTATUS(2)) += (BASE:ARG:LV - 80) * 11 / 4
				;회피
				BASE:ARG:(GET_BATTLESTATUS(3)) += (BASE:ARG:LV - 80) * 7 / 4
				;마법위력
				BASE:ARG:(GET_BATTLESTATUS(4)) += (BASE:ARG:LV - 80) * 9 / 4
				;마법효과
				BASE:ARG:(GET_BATTLESTATUS(5)) +=(BASE:ARG:LV - 80) * 7 / 4
			ENDIF
			;총명중
			BASE:ARG:총명중 += (BASE:ARG:LV - 80) * 7 / 4
			;총공격
			BASE:ARG:총공격 += (BASE:ARG:LV - 80) * 9 / 4
		ENDIF
		
		;장비品の보정
		;장비効果설정が通常
		IF BATTLE_SETTING_IS_EQUIPTHEORY() == 0
			FOR LCOUNT,0,FLAG:전투능력数
				LEQUIP_FIXED_VALUE = 0
				FOR LCOUNT:1,0,7
					IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
						CALLFORM 전투능력수정_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
					ELSE
						CALLFORM 전투능력수정_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},LCOUNT,ARG
					ENDIF
					LEQUIP_FIXED_VALUE += RESULT
				NEXT
				MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, LEQUIP_FIXED_VALUE)
			NEXT
		
		;장비効果설정が변경あり
		;---- EDIT 024 DEL START -------------------------
		;ELSE
		;	FOR LCOUNT,FLAG:전투능력数-2,FLAG:전투능력数
		;		LEQUIP_FIXED_VALUE = 0
		;		FOR LCOUNT:1,0,7
		;			IF 마정장비(EQUIP:ARG:(GET_EQUIP(LCOUNT:1)))
		;				CALLFORM 전투능력수정_마정장비,LCOUNT,EQUIP:ARG:(GET_EQUIP(LCOUNT:1)) - 2450 -450*LCOUNT:1
		;			ELSE
		;				CALLFORM 전투능력수정_{EQUIP:ARG:(GET_EQUIP(LCOUNT:1))},LCOUNT,ARG
		;			ENDIF
		;			LEQUIP_FIXED_VALUE += RESULT
		;		NEXT
		;		MAXBASE:ARG:(GET_BATTLESTATUS(LCOUNT)) = BASE:ARG:(GET_BATTLESTATUS(LCOUNT)) + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, LEQUIP_FIXED_VALUE)
		;	NEXT
		;---- EDIT 024 DEL END ---------------------------
		ENDIF
		
		;검장비の処理
		IF 마정장비(EQUIP:ARG:검)
			CALLFORM 공격상성_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:공격상성 = RESULT
			CALLFORM 사거리_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:사거리 = RESULT
			CALLFORM 최저공격횟수_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:최저공격횟수 = RESULT
			CALLFORM 최대공격횟수_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:최대공격횟수 = RESULT
			CALLFORM 공격범위_마정장비,EQUIP:ARG:검-2450
			ABL:ARG:공격범위 = RESULT
			TRYCCALLFORM 추가효과_마정장비,EQUIP:ARG:검-2450
				ABL:ARG:추가효과 = RESULT
				CALLFORM 추가효과상성_마정장비,EQUIP:ARG:검-2450
				ABL:ARG:추가효과상성 = RESULT
				CALLFORM 추가효과명중률_마정장비,EQUIP:ARG:검-2450
				ABL:ARG:추가효과명중률 = RESULT
				CALLFORM 추가효과최대명중률_마정장비,EQUIP:ARG:검-2450
				ABL:ARG:추가효과최대명중률 = RESULT
			CATCH
				ABL:ARG:추가효과 = 0
				ABL:ARG:추가효과상성 = 0
				ABL:ARG:추가효과명중률 = 0
				ABL:ARG:추가효과최대명중률 = 0
			ENDCATCH
		ELSE
			CALLFORM 공격상성_{EQUIP:ARG:검},ARG
			ABL:ARG:공격상성 = RESULT
			CALLFORM 사거리_{EQUIP:ARG:검},ARG
			ABL:ARG:사거리 = RESULT
			CALLFORM 최저공격횟수_{EQUIP:ARG:검},ARG
			ABL:ARG:최저공격횟수 = RESULT
			CALLFORM 최대공격횟수_{EQUIP:ARG:검},ARG
			ABL:ARG:최대공격횟수 = RESULT
			CALLFORM 공격범위_{EQUIP:ARG:검},ARG
			ABL:ARG:공격범위 = RESULT
			TRYCCALLFORM 추가효과_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과 = RESULT
				CALLFORM 추가효과상성_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과상성 = RESULT
				CALLFORM 추가효과명중률_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과명중률 = RESULT
				CALLFORM 추가효과최대명중률_{EQUIP:ARG:검},ARG
				ABL:ARG:추가효과최대명중률 = RESULT
			CATCH
				ABL:ARG:추가효과 = 0
				ABL:ARG:추가효과상성 = 0
				ABL:ARG:추가효과명중률 = 0
				ABL:ARG:추가효과최대명중률 = 0
			ENDCATCH
		ENDIF

		;총장비の処理
		IF EQUIP:ARG:총 > 0
			IF 마정장비(EQUIP:ARG:총)
				CALLFORM 총명중_마정장비,EQUIP:ARG:총-2900
				MAXBASE:ARG:총명중 = BASE:ARG:총명중 + SKILL_EQUIPTHEORY_EQUIP_HIT(ARG, RESULT)
				CALLFORM 총공격_마정장비,EQUIP:ARG:총-2900
				MAXBASE:ARG:총공격 = BASE:ARG:총공격 + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, RESULT)
			ELSE
				CALLFORM 총명중_{EQUIP:ARG:총},ARG
				MAXBASE:ARG:총명중 = BASE:ARG:총명중 + SKILL_EQUIPTHEORY_EQUIP_HIT(ARG, RESULT)
				CALLFORM 총공격_{EQUIP:ARG:총},ARG
				MAXBASE:ARG:총공격 = BASE:ARG:총공격 + SKILL_EQUIPTHEORY_EQUIP_STATUS(ARG, RESULT)
			ENDIF
			
		ELSE
			MAXBASE:ARG:총명중 = 0
			MAXBASE:ARG:총공격 = 0
		ENDIF
	ENDIF
	

	;조교効果をここに記述・전투能力
	IF ARG != MASTER && CFLAG:ARG:PTフラグ > 0
		;現状処理なし
	ENDIF
	
	;相性関係
	FOR LOCAL:1,0,FLAG:相性数 +1
		IF CFLAG:ARG:악마변신 == 0
			MAXBASE:ARG:GET_TYPE(LOCAL:1) = BASE:ARG:GET_TYPE(LOCAL:1)
			SIF CFLAG:ARG:변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:ARG:변경相性치1
			SIF CFLAG:ARG:추가변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:ARG:추가변경相性치1
			;プラグイン（악세사리）を見る
			CALLFORM 방어상성_{EQUIP:ARG:악세사리},LOCAL:1,ARG
			IF RESULT != 100
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = RESULT
			ENDIF
		ELSEIF CFLAG:ARG:링크악마 > 0 && FINDCHARA_ID(CFLAG:ARG:링크악마) > 0
			;변신先악마が居れば、その악마の相性をコピー
			MAXBASE:ARG:GET_TYPE(LOCAL:1) = BASE:FINDCHARA_ID(CFLAG:ARG:링크악마):GET_TYPE(LOCAL:1)
			SIF CFLAG:FINDCHARA_ID(CFLAG:ARG:링크악마):변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:FINDCHARA_ID(CFLAG:ARG:링크악마):변경相性치1
			SIF CFLAG:FINDCHARA_ID(CFLAG:ARG:링크악마):추가변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:FINDCHARA_ID(CFLAG:ARG:링크악마):추가변경相性치1
		ELSE
			;디폴트악마の場合は相性コピー＋相性변경は自分のを사용する
			MAXBASE:ARG:GET_TYPE(LOCAL:1) = CSVBASE((CFLAG:ARG:초기링크악마), GETNUM(BASE , GET_TYPE(LOCAL:1)),0)
			SIF CFLAG:ARG:변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:ARG:변경相性치1
			SIF CFLAG:ARG:추가변경相性1 == LOCAL:1+1
				MAXBASE:ARG:GET_TYPE(LOCAL:1) = CFLAG:ARG:추가변경相性치1
		ENDIF
	NEXT

	FOR LOCAL:1,0,FLAG:ステート数
		IF CFLAG:ARG:악마변신 == 0
			MAXBASE:ARG:GET_STATE(LOCAL:1) = BASE:ARG:GET_STATE(LOCAL:1)
			;プラグイン（악세사리）を見る
			RESULT = 0
			TRYCALLFORM バステ내성_{EQUIP:ARG:악세사리},LOCAL:1,ARG
			IF RESULT < 0
				MAXBASE:ARG:GET_STATE(LOCAL:1) = RESULT
			ENDIF
		ELSEIF FINDCHARA_ID(CFLAG:ARG:링크악마) > 0
			;변신先악마が居れば、その악마の相性をコピー
			MAXBASE:ARG:GET_STATE(LOCAL:1) = BASE:FINDCHARA_ID(CFLAG:ARG:링크악마):GET_STATE(LOCAL:1)
		ELSE
			;디폴트악마の場合は相性コピー＋相性변경は自分のを사용する
			MAXBASE:ARG:GET_STATE(LOCAL:1) = CSVBASE((CFLAG:ARG:초기링크악마), GETNUM(BASE , GET_STATE(LOCAL:1)),0)
		ENDIF
	NEXT

	IF CFLAG:ARG:악마변신
		IF FINDCHARA_ID(CFLAG:ARG:링크악마) > 0
			ABL:ARG:공격상성 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):공격상성
			ABL:ARG:사거리 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):사거리
			ABL:ARG:최저공격횟수 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):최저공격횟수
			ABL:ARG:최대공격횟수 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):최대공격횟수
			ABL:ARG:공격범위 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):공격범위
			ABL:ARG:추가효과 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):추가효과
			ABL:ARG:추가효과상성 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):추가효과상성
			ABL:ARG:추가효과명중률 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):추가효과명중률
			ABL:ARG:추가효과최대명중률 = ABL:FINDCHARA_ID(CFLAG:ARG:링크악마):추가효과최대명중률
		ELSE
			ABL:ARG:공격상성 = ABL:ARG:초기링크악마공격상성
			ABL:ARG:사거리 = ABL:ARG:초기링크악마사거리
			ABL:ARG:최저공격횟수 = ABL:ARG:초기링크악마최저공격횟수
			ABL:ARG:최대공격횟수 = ABL:ARG:초기링크악마최대공격횟수
			ABL:ARG:공격범위 = ABL:ARG:초기링크악마공격범위
			ABL:ARG:추가효과 = ABL:ARG:초기링크악마추가효과
			ABL:ARG:추가효과상성 = ABL:ARG:초기링크악마추가효과상성
			ABL:ARG:추가효과명중률 = ABL:ARG:초기링크악마추가효과명중률
			ABL:ARG:추가효과최대명중률 = ABL:ARG:초기링크악마추가효과최대명중률
		ENDIF
	ENDIF

	;NEXT経験値
	MAXBASE:ARG:ＥＸＰ  = 5*(BASE:ARG:LV)*(BASE:ARG:LV+1)*(BASE:ARG:LV+2)/3
	SIF ABL:ARG:종족 != 0 && !함락(ARG)
		TIMES MAXBASE:ARG:ＥＸＰ , 1.25
	;ＭＡＧキャパシティ
	IF ARG == MASTER
		MAXBASE:ARG:ＭＡＧ  = (75)*(LOCAL)*(LOCAL+1)*(LOCAL+2)
	ELSE
		MAXBASE:ARG:ＭＡＧ  = (15+함락(ARG)*3)*(MAXBASE:ARG:LV)*(MAXBASE:ARG:LV+1)*(MAXBASE:ARG:LV+2)
		SIF ABL:ARG:종족 == 45
			MAXBASE:ARG:ＭＡＧ *= 5
	ENDIF
	;抗体ポイント
	IF CSVBASE(NO:ARG,GETNUM(BASE,"CP"),0) != 0 && CFLAG:ARG:PTフラグ > 0
		 LOCAL:1 = 15
		 FOR LOCAL,0,FLAG:相性数 +1
		 	SELECTCASE MAXBASE:ARG:(GET_TYPE(LOCAL))
		 		CASE 999
		 			LOCAL:1 += 55
		 		CASE IS < 0
		 			LOCAL:1 += 55
		 		CASE 0
		 			LOCAL:1 += 40
		 		CASE IS > 199
		 			LOCAL:1 -= 25
		 		CASE IS > 100
		 			LOCAL:1 -= 15
		 		CASE IS <= 50
		 			LOCAL:1 += 25
		 		CASE IS < 100
		 			LOCAL:1 += 15
		 	ENDSELECT
		 NEXT
		BASE:ARG:CP = MAX(1,LOCAL:1/2) + CFLAG:ARG:ＣＰ보정
		TRYCCALLFORM 증가CP_{EQUIP:ARG:악세사리}
			RESULT += 100
		CATCH
			RESULT = 100
		ENDCATCH
		MAXBASE:ARG:CP = MAX(1,BASE:ARG:CP * MAXBASE:ARG:LV / 50 * (100-MIN(10000,BASE:ARG:충성도)*50/10000) / 100 * RESULT / 100)
		MAXBASE:ARG:￥ = MAX(1,BASE:ARG:CP * MAXBASE:ARG:LV * (100-MIN(5000,BASE:ARG:충성도)*90/5000) / 100)
	ELSE
		MAXBASE:ARG:CP = BASE:ARG:CP * MAXBASE:ARG:LV / 50
		MAXBASE:ARG:￥ = 0
	ENDIF
ENDIF

;主人の場合、속성が変動する。
;主人以外も変化するようにしてみる
;IF ARG == MASTER
	;LD
	SELECTCASE CFLAG:ARG:善悪치
		CASE IS > 170
			ABL:ARG:속성LD = 1
		CASE IS > 84
			ABL:ARG:속성LD = 2
		CASEELSE
			ABL:ARG:속성LD = 3
	ENDSELECT
	SELECTCASE CFLAG:ARG:秩混치
		CASE IS > 170
			ABL:ARG:속성LC = 1
		CASE IS > 84
			ABL:ARG:속성LC = 2
		CASEELSE
			ABL:ARG:속성LC = 3
	ENDSELECT
;ENDIF

;---- EDIT 028 MOD START -------------------------
;蠅상태で내성변경
IF GET_STATE(CFLAG:ARG:ステート) == "FLY"
	FOR LCOUNT,0,FLAG:相性数 + 1
		MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 100
		SIF LCOUNT == 4 || LCOUNT == 7 || LCOUNT == 14 || LCOUNT == 16
			MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 400
	NEXT
ENDIF
;---- EDIT 028 MOD END ---------------------------
;분노의○○を사용すると弱点が増える
FOR LCOUNT,0,FLAG:相性数 + 1
	SIF GETBIT(CFLAG:ARG:熱り弱点부여,LCOUNT)
		MAXBASE:ARG:(GET_TYPE(LCOUNT)) = 150
NEXT
;아이템사용関係
LOCAL = MIN(HAVE_SKILL_OVERLAP(ARG,[[스킬:아이템숙련]]),2)
CFLAG:ARG:아이템사용능력 = TALENT:ARG:도구지식 + TALENT:ARG:아이템숙련 + LOCAL
CFLAG:ARG:아이템사용강화 = TALENT:ARG:아이템숙련 + LOCAL * 2

;임신している場合、一部の能力にボーナス？
;現状では최대ＨＰとＭＰが2割上昇
IF TALENT:ARG:임신
	TIMES MAXBASE:ARG:ＨＰ , 1.20
	TIMES MAXBASE:ARG:ＭＰ , 1.20
ENDIF
;붕괴している場合、ＨＰとＭＰが7割に
IF TALENT:ARG:붕괴
	TIMES MAXBASE:ARG:ＨＰ , 0.70
	TIMES MAXBASE:ARG:ＭＰ , 0.70
ENDIF

;ガチャモードがONで、아군なら{(종족악마and全書소환불가でない)or(조마である)}andガチャ素質が無い　なら色々반감
IF FLAG:악마가챠모드 > 1 && CFLAG:ARG:PTフラグ > 0
	IF ((ABL:ARG:종족 > 0 && ABL:ARG:종족 < 45 && CFLAG:ARG:전서소환불가 == 0) || (ABL:ARG:종족 == 45)) && TALENT:ARG:ガチャ < 1
		TIMES MAXBASE:ARG:ＨＰ , 0.50
		TIMES MAXBASE:ARG:ＭＰ , 0.50
		TIMES BASE:ARG:공격 , 0.50
		TIMES BASE:ARG:명중 , 0.50
		TIMES BASE:ARG:방어 , 0.50
		TIMES BASE:ARG:회피 , 0.50
		TIMES BASE:ARG:마법위력 , 0.50
		TIMES BASE:ARG:마법효과 , 0.50
		TIMES BASE:ARG:총공격 , 0.50
		TIMES BASE:ARG:총명중 , 0.50
	ENDIF
ENDIF

SIF MAXBASE:ARG:ＭＡＧ < 1
	MAXBASE:ARG:ＭＡＧ = 1

;페르소나구사자の場合、스테이터스の変動にあわせて現HP/MPも変動する
IF TALENT:ARG:페르소나구사자
	IF MIN(BASE:ARG:ＨＰ,LOCAL:7) != 0
		BASE:ARG:ＨＰ *= MAXBASE:ARG:ＨＰ
		BASE:ARG:ＨＰ /= LOCAL:7
	ENDIF
	IF MIN(BASE:ARG:ＭＰ,LOCAL:8) != 0
		BASE:ARG:ＭＰ *= MAXBASE:ARG:ＭＰ
		BASE:ARG:ＭＰ /= LOCAL:8
	ENDIF
ENDIF
;한글판 개조 자동효과 스킬 마술용심・마력방출을 가지고 있을때, 공격력에 마법위력의 1 / 4 을 추가한다.
SIF HAVE_SKILL(ARG,2561)
	MAXBASE:ARG:(GET_BATTLESTATUS(0)) += MAXBASE:ARG:(GET_BATTLESTATUS(4)) / 4
;자동효과 스킬 황제특권을 가지고 있을때, 공격, 명중, 방어, 회피, 마법위력, 마법효과에 레벨을 더한다.
IF HAVE_SKILL(ARG,2562)
	MAXBASE:ARG:(GET_BATTLESTATUS(0)) += MAXBASE:ARG:LV
	MAXBASE:ARG:(GET_BATTLESTATUS(1)) += MAXBASE:ARG:LV
	MAXBASE:ARG:(GET_BATTLESTATUS(2)) += MAXBASE:ARG:LV
	MAXBASE:ARG:(GET_BATTLESTATUS(3)) += MAXBASE:ARG:LV
	MAXBASE:ARG:(GET_BATTLESTATUS(4)) += MAXBASE:ARG:LV
	MAXBASE:ARG:(GET_BATTLESTATUS(5)) += MAXBASE:ARG:LV
ENDIF
;한글판 개조 끝
;=================================================================
;仲魔として加入
;ARG:NO
;ARG:1 충성도
;ARG:2 이벤트フラグ(通常の他-1のとき、合体時の一時표시に作成された악마であることを示す)
;ARG:3 마코토(페르소나5):全書利用時に一時的に仲魔に加える処理であることを示す。소지数警告や加入キャンセルを無効にする
;RESULT 마코토(페르소나5):キャラが作成されたことを示す。偽:既に同一キャラがいた場合や人数制限にかかった場合などでキャラが作成されなかった場合
;RRSULT:1 作成したキャラの登録番号を返す
;=================================================================
@ADD_NEW_COMPANION, ARG, ARG:1, ARG:2 = 0, ARG:3 = 0
#DIMS 이상경험名 , 64
#DIMS 초기호감도値 , 60
#DIM LCOUNT
;인간or메어리かつ既に仲魔に居るならスルー
;랜덤キャラはスルーしない
;引継ぎ당신または랜덤な다크서머너(Noが4998)もスルーしない
;IF (ARG < 4901 || ARG > 4910) && (ARG != 0 && ARG != 4999)
IF (ARG < 4901 || ARG > 4910) && (ARG != 4998)
	IF (CSVABL(ARG,GETNUM(ABL,"종족"),0) == 0 || ARG == 4509) && GETCHARA(ARG) > -1
		CFLAG:GETCHARA(ARG):この場に居ないフラグ = 0
		CALLF FINDCHARA_B(ARG)
		RETURN 0
	ELSEIF ARG:2 > 0 && FINDCHARA_B(ARG,ARG:2) >= 0
		;RESULT:1には既に番号が返されてるはず
		RETURN 0
	ENDIF
ENDIF
FOR LOCAL:2, 0, 200
	SIF !CMATCH(CFLAG:キャラ固有の번호, LOCAL:2)
		BREAK
	IF !ARG:3
		IF LOCAL:2 == 195
			PRINTW ※소지하고 있는 캐릭터가 195체에 도달했습니다
			PRINTW 　200체가 넘으면、가입처리가 취소되므로 주의해주세요
		ENDIF
		IF LOCAL:2 == 199
			PRINTW 캐릭터수가 한계에 도달했습니다
			PRINTW 캐릭터의 가입처리를 취소합니다
			RETURN 0
		ENDIF
	ENDIF
NEXT
;抜けた段階で+1されるので調整
LOCAL:2 -= 1
;	;RESULT配列に使われてる固有の番号を全部書きだす
;	VARSET RESULT, -1
;	FOR LOCAL:2, 0 , CHARANUM
;		SIF CFLAG:(LOCAL:2):キャラ固有の번호 > 0
;			RESULT:(CFLAG:(LOCAL:2):キャラ固有の번호) = LOCAL:2
;	NEXT
;	;主人は0固定のはずなので、0にする
;	RESULT = 0
;	;書きだしたリストから、開いている一番若い番号を探しす
;	FOR LOCAL:2, 0 , 201
;		SIF RESULT:(LOCAL:2) >= 0
;			CONTINUE
;		BREAK
;	NEXT
;	IF LOCAL:2 == 201
;		PRINTW キャラクター数が上限に達しています
;		PRINTW キャラクター加入処理をキャンセルします
;		RETURN 0
;	ELSEIF LOCAL:2 >= 195
;		PRINTW ※소지しているキャラが195体に達しています
;		PRINTW 　200体を超えると、加入処理がキャンセルされますので注意してください
;	ENDIF
LOCAL = CHARANUM
LOCAL:1 = TARGET
ADDCHARA ARG
TARGET = LOCAL:1
CFLAG:LOCAL:PTフラグ = 1
CFLAG:LOCAL:キャラ固有の번호 = LOCAL:2
;一応RESULTを破壊しておく
VARSET RESULT
;위험일を설정する
ENCODETOUNI %NAME:LOCAL%
LOCAL:1 = RESULT+1
IF ABL:LOCAL:종족 == 0 || ABL:LOCAL:종족 == 45
	CFLAG:LOCAL:위험일 = (SUMARRAY(RESULT , 1 , LOCAL:1) + DAY*4 + TIME)%16
ELSE
	CFLAG:LOCAL:위험일 = (SUMARRAY(RESULT , 1 , LOCAL:1) + DAY*4 + TIME)%15
	SIF CFLAG:LOCAL:위험일 >= 8
		CFLAG:LOCAL:위험일 += 1
ENDIF
VARSET RESULT
CFLAG:LOCAL:조교메뉴표시설정 = GLOBAL:9
;経験値、マグネタイト、충성도の초기化、仲魔フラグ
LOCAL:2 = MAXBASE:LOCAL:(GET_BASESTATUS(0))
BASE:LOCAL:ＥＸＰ = 5*(LOCAL:2-1)*(LOCAL:2+1)*(LOCAL:2)/3
SIF ABL:LOCAL:종족 != 0
	TIMES BASE:LOCAL:ＥＸＰ , 1.25

SIF ABL:LOCAL:종족 == 45
	BASE:LOCAL:ＥＸＰ = 0
BASE:LOCAL:ＭＡＧ = 0
BASE:LOCAL:충성도 = ARG:1
MAXBASE:LOCAL:충성도 = 0
;ＭＡＧ自己소비フラグをＯＦＦ
CFLAG:LOCAL:ＭＡＧ自己소비 = 0
;인간ならば전투참가不能
SIF (ABL:LOCAL:종족 > 45 || ABL:LOCAL:종족 == 0) && LOCAL != MASTER
	CFLAG:LOCAL:전투참가불가능 = 1
;善悪치・秩混치未설정の場合、설정
CALL ADJUST_CHARA_ALI,LOCAL
;적専用스킬を削除
FOR LOCAL:3,1,FLAG:스킬数+1
	LOCALS = 스킬{LOCAL:3}
	TRYCCALLFORM 적専用_{ABL:LOCAL:LOCALS}
		SIF RESULT == 1
			ABL:LOCAL:LOCALS = 0
	CATCH
	ENDCATCH
NEXT

;던전や의뢰ごとの修正
SELECTCASE FLAG:SHOPコマンド
	CASE [[SHOP:탐색]]
		TRYCALLFORM SET_COMPANION_DUNGEON_{FLAG:現던전} , LOCAL
	CASE [[SHOP:콜로세움참가]]
		TRYCALLFORM SET_COMPANION_COLOSSEUM_{FLAG:進行中コロシアム} , LOCAL
	CASE [[SHOP:이벤트]]
		TRYCALLFORM SET_COMPANION_EVENT_{FLAG:進行中이벤트} , LOCAL
	CASE [[SHOP:의뢰청부]]
		TRYCALLFORM SET_COMPANION_REQUEST_{FLAG:進行中의뢰} , LOCAL
ENDSELECT

;착의状況をセット
LOCAL:1 = 1
FOR LCOUNT, 0, 12
	CFLAG:LOCAL:(60+LCOUNT) = CFLAG:LOCAL:GET_CLOTHESNAME(LCOUNT)
	SIF CFLAG:LOCAL:GET_CLOTHESNAME(LCOUNT)
		CFLAG:LOCAL:23 |= LOCAL:1
	LOCAL:1 *= 2
NEXT
CFLAG:LOCAL:24 = CFLAG:LOCAL:23

CFLAG:LOCAL:被リンクフラグ = -1
CFLAG:LOCAL:링크악마 = -1

;초기マスター만트라
IF TALENT:LOCAL:식노
	FOR LOCAL:1, 1, 9
		SIF ABL:LOCAL:@"스킬{LOCAL:1}"
			CDFLAG:LOCAL:만트라:(ABL:LOCAL:@"스킬{LOCAL:1}") = 10000
		ABL:LOCAL:@"스킬{LOCAL:1}" = 0
	NEXT
ENDIF

;초기레벨を保存
CFLAG:LOCAL:초기LV = BASE:LOCAL:LV
CFLAG:LOCAL:이벤트加入 = ARG:2

;초기이상경험分を加算
IF CSTR:LOCAL:초기이상경험 != ""
	VARSET 이상경험名
	SPLIT CSTR:LOCAL:초기이상경험 , "_" , 이상경험名
	FOR LOCAL:1 , 0 , STRCOUNT(CSTR:LOCAL:초기이상경험 , "_") + 1
		SETBIT CFLAG:LOCAL:이상경험記録 , NUM_ABNORMAL_EXP(이상경험名:(LOCAL:1))
		EXP:LOCAL:이상경험 += RANK_ABNORMAL_EXP(이상경험名:(LOCAL:1))
	NEXT
ENDIF
CFLAG:LOCAL:초기이상경험 = EXP:LOCAL:이상경험

CFLAG:LOCAL:娘の父親の固有번호娘 = -1
CFLAG:LOCAL:娘の産みの親の固有번호娘 = -1

;초기호감도
;加入キャラに호감도と被호감도の데이터を両方持たせておき、加入時点で相손をサーチして両方上書きする
;배우자・近親はデフォで초기호감도を持つ
VARSET 초기호감도値
SPLIT CSTR:LOCAL:초기호감도, "_", 초기호감도値
FOR LOCAL:1, 0, CHARANUM
	LOCAL:2 = FINDELEMENT(초기호감도値, CSVCALLNAME(NO:(LOCAL:1), 0), , , 1)
	IF LOCAL:2 > 0
		CFLAG:LOCAL:(CFLAG:(LOCAL:1):キャラ固有の번호 + 2100) = TOINT(초기호감도値:(LOCAL:2 + 1))
		CFLAG:(LOCAL:1):(CFLAG:LOCAL:キャラ固有の번호 + 2100) = TOINT(초기호감도値:(LOCAL:2 + 2))
	ELSEIF CSV배우자(LOCAL, LOCAL:1)
		CFLAG:LOCAL:(CFLAG:(LOCAL:1):キャラ固有の번호 + 2100) = 2000
		CFLAG:(LOCAL:1):(CFLAG:LOCAL:キャラ固有の번호 + 2100) = 2000
	ELSEIF 近親체크(LOCAL, LOCAL:1)
		CFLAG:LOCAL:(CFLAG:(LOCAL:1):キャラ固有の번호 + 2100) = 500
		CFLAG:(LOCAL:1):(CFLAG:LOCAL:キャラ固有の번호 + 2100) = 500
	ENDIF
NEXT

;キャラ相性の초기値は-1(不在)
FOR LOCAL:1, 1, 21
	CFLAG:LOCAL:@"キャラ相性{LOCAL:1}" = -1
NEXT

;二人称の変換
IF STRFIND(CSTR:LOCAL:二人称 , "NAME:MASTER") > -1
	IF NAME:MASTER == "당신" || CALLNAME:MASTER == "당신"
		CSTR:LOCAL:二人称 = 당신
	ELSEIF STRFIND(CSTR:LOCAL:二人称 , "CALLNAME:MASTER") > -1
		CSTR:LOCAL:二人称 = %CALLNAME:MASTER + SUBSTRING(CSTR:LOCAL:二人称 , 17)%
	ELSE
		CSTR:LOCAL:二人称 = %NAME:MASTER + SUBSTRING(CSTR:LOCAL:二人称 , 13)%
	ENDIF
ENDIF
CALL CONVERT_SECOND_PERSON, LOCAL

;---- EDIT 026 MOD START -------------------------
;---- EDIT 025 ADD START -------------------------
;악마が容量を超えて仲魔になった場合、ＤＤＭ사용中ならその기능で자택서버ーに転送することを説明
IF ＣＯＭＰ空き容量() == -1 && SOFT_ON("ＤＤＭ") && FLAG:合体予定악마1 == -1 && ABL:LOCAL:종족 != 0
	CFLAG:LOCAL:所属ＣＯＭＰ = -1
	PRINTFORMW ＣＯＭＰ에 빈 용량이 없으므로、ＤＤＭ으로 자택서버에 전송했습니다
ENDIF

;ＤＤＭ不사용時に容量を超えて仲魔になった場合のため、元の処理も残しておく
;---- EDIT 025 ADD END ---------------------------
;容量を超えて仲魔になった場合、자택서버ーに転送
IF ＣＯＭＰ空き容量() == -1 && FLAG:合体予定악마1 == -1
	CFLAG:LOCAL:所属ＣＯＭＰ = -1
ENDIF
;---- EDIT 026 MOD END -------------------------

;설정された性別の場合、요바이を불허가に
IF (FLAG:요바이불허가성별 & 2 && TALENT:LOCAL:오토코노코)
	CFLAG:LOCAL:요바이불허가 = 1
ELSEIF (FLAG:요바이불허가성별 & 1 && TALENT:LOCAL:남자 && TALENT:LOCAL:오토코노코 == 0)
	CFLAG:LOCAL:요바이불허가 = 1
ELSEIF (FLAG:요바이불허가성별 & 4 && TALENT:LOCAL:남자 == 0)
	CFLAG:LOCAL:요바이불허가 = 1
ENDIF

;全コマンド系統필터ＯＮ
FOR LOCAL:1 , 0 , 13
	CFLAG:LOCAL:(170+LOCAL:1) = 1
NEXT
CALL SYNC_STATUS,LOCAL
CALL HEALTH_CHARA,LOCAL
RESULT:1 = LOCAL
RETURN 1


;=======================================
;적キャラクターの消滅
;=======================================
@DELENEMY
SIF FLAG:デバッグ전투フラグ
	RETURN 0
FOR LOCAL,CHARANUM,0,-1
	IF CFLAG:(LOCAL-1):PTフラグ == 0
		SIF CFLAG:(LOCAL-1):포지션 > 0
			CALL REMOVE_POSITION,CFLAG:(LOCAL-1):포지션
		DELCHARA (LOCAL-1)
	ENDIF
NEXT
;===============================
;キャラクター全쾌
;===============================
@HEALTH_CHARA,ARG
BASE:ARG:ＨＰ = MAXBASE:ARG:ＨＰ
BASE:ARG:ＭＰ = MAXBASE:ARG:ＭＰ
CFLAG:ARG:ステート = 0
CFLAG:ARG:ステート経過ターン = 0


;=======================================================
;스킬実行時の기본的な動作
;=======================================================

;HPの増減処理
@VAR_HP,ARG,ARG:1,ARG:2
;ARG:2　0通常のダメージorマッスルドリンコ的회복　1이악물기有効　2불굴의투지有効　3通常の회복　4아르카나시프트　5ネバーギブアップ有効
SIF GET_STATE(CFLAG:(ARG):ステート) == "DYING" && ARG:1 < 0
	RETURN 0
BASE:ARG:ＨＰ += ARG:1

;---- EDIT 020 ADD START -------------------------
IF FLAG:ムフフ전개 && EQUIP:MASTER:엑스링케이지
	;受けたダメージ量の최대HPに対する割合に、욕망と마조끼をかけて던전内発情用욕정치が増加
	CFLAG:ARG:던전内発情用욕정치 += ARG:1 * (ABL:ARG:욕망 + ABL:ARG:마조끼) / MAXBASE:ARG:ＨＰ
ENDIF
;---- EDIT 020 ADD END -------------------------

IF BASE:ARG:ＨＰ < 1
	IF CFLAG:ARG:不死身フラグ
		IF CFLAG:ARG:不死身フラグ > 1
			PRINTL
			PRINTFORM \@ CFLAG:ARG:不死身フラグ == 2 ? %CALLNAME:ARG%は食いしばった！ # %CALLNAME:ARG%は立ち上がった！ \@
		ENDIF
		BASE:ARG:ＨＰ = (CFLAG:ARG:不死身フラグ == 3 ? MAXBASE:ARG:ＨＰ # 1)
		CFLAG:ARG:이악물기フラグ = 1
	ELSEIF ARG:2 == 1
		BASE:ARG:ＨＰ = 1
		PRINTL
		PRINTFORM %조사처리(CALLNAME:ARG,"는")% 이를 악물었다！
	ELSEIF ARG:2 == 2
		BASE:ARG:ＨＰ = MAXBASE:ARG:5
		PRINTL
		PRINTFORM %조사처리(CALLNAME:ARG,"는")% 일어섰다！
	ELSEIF ARG:2 == 5
		BASE:ARG:ＨＰ = MAXBASE:ARG:5
		PRINTL
		PRINTFORM %CALLNAME:ARG%는 아직 싸울 생각이다！
	;잠재능력
	;페르소나구사자であり潜在復活・特殊を持つ時発動
	ELSEIF TALENT:(ARG):페르소나구사자 >= 1 && (ABL:ARG:잠재능력 == 3 || ABL:ARG:잠재능력 == 4) && CFLAG:ARG:PTフラグ
		;潜在復活
									;!CFLAG:(LOCAL:1):잠재능력発動횟수
		IF ABL:ARG:잠재능력 == 3 && !CFLAG:(LOCAL:1):1263
			;相性☆
			IF GET_P_FITNESS(ARG, 0) >= 3
				PRINTL
				SETCOLOR 0x66FFFF
				PRINT 　　잠재부활 
				RESETCOLOR
				BASE:ARG:ＨＰ = MAXBASE:ARG:ＨＰ
					PRINTFORM %조사처리(CALLNAME:ARG,"는")% 일어섰다！
			;相性◎
			ELSEIF GET_P_FITNESS(ARG, 0) == 2
				PRINTL
				SETCOLOR 0x66FFFF
				PRINT 　　잠재부활 
				RESETCOLOR
				BASE:ARG:ＨＰ = MAXBASE:ARG:ＨＰ / 4
					PRINTFORM %조사처리(CALLNAME:ARG,"는")% 일어섰다！
			ENDIF
			CFLAG:(LOCAL:1):1263 = 4;CFLAG:(LOCAL:1):잠재능력発動횟수 = 4
		ENDIF
						;CFLAG:(LOCAL:1):잠재능력発動횟수 < 4
		IF RAND:2 == 0 && CFLAG:(LOCAL:1):1263 < 4
			;잠재특수
			IF ABL:ARG:잠재능력 == 4
				;相性☆
				IF GET_P_FITNESS(ARG, 0) >= 3
					PRINTL
					SETCOLOR 0x66FFFF
					PRINTFORML 　　%CALLNAME:ARG% 잠재특수공격
					RESETCOLOR
					CALLFORM ACTION_2010, ARG, 22
				;相性◎
				ELSEIF GET_P_FITNESS(ARG, 0) == 2
					PRINTL
					SETCOLOR 0x66FFFF
					PRINTFORML 　　%CALLNAME:ARG% 잠재특수공격
					RESETCOLOR
				CALLFORM ACTION_2010, ARG, 22
				ENDIF
				CFLAG:(LOCAL:1):1263 ++;CFLAG:(LOCAL:1):잠재능력発動횟수 ++
			ENDIF
		ELSEIF BASE:ARG:ＨＰ < 1
			CALL DEAD_CHARA,ARG
		ENDIF
	ELSE
		CALL DEAD_CHARA,ARG
	ENDIF
ELSEIF BASE:ARG:ＨＰ > MAXBASE:ARG:ＨＰ && ARG:2 == 3
	BASE:ARG:ＨＰ = MAXBASE:ARG:ＨＰ
ENDIF


;MPの増減処理
@VAR_MP,ARG,ARG:1,ARG:2
;ARG:2　0通常のダメージorマッスルドリンコ的회복　1이악물기有効　2불굴의투지有効　3通常の회복　4아르카나시프트　5ネヴァーギブアップ有効
BASE:ARG:ＭＰ += ARG:1
IF BASE:ARG:ＭＰ < 1
	IF ARG:2 == 1
		BASE:ARG:ＭＰ = 1
	ELSEIF ARG:2 == 2
		BASE:ARG:ＭＰ = MAXBASE:ARG:ＭＰ
	ELSEIF ARG:2 == 5
		BASE:ARG:ＭＰ = MAXBASE:ARG:ＭＰ
	ELSE
		BASE:ARG:ＭＰ = 0
	ENDIF
ELSEIF BASE:ARG:ＭＰ > MAXBASE:ARG:ＭＰ && ARG:2 == 3
	BASE:ARG:ＭＰ = MAXBASE:ARG:ＭＰ
ENDIF





;기본的な物理명중판정の処理
@JUDG_HIT_1,ARG,ARG:1,ARG:2
;ARG 공격者
;ARG:1 被공격者
;ARG:2 스킬명중률
;LOCAL 能力差による기본명중률
LOCAL = 80 - (MAXBASE:(ARG:1):(GET_BATTLESTATUS(3))) + (MAXBASE:ARG:(GET_BATTLESTATUS(1)))
LOCAL *= (48 + CFLAG:ARG:명중강화 + CHECK_SKILL(ARG:1,2447)*4 + CHECK_SKILL(ARG:1,2448)*8 + CHECK_SKILL(ARG:1,2449)*4)
LOCAL /= 48
LOCAL *= (48 - CFLAG:(ARG:1):회피강화)
LOCAL /= 48

;バステ影響설정有効
IF BATTLE_SETTING_IS_BAD_STATUS()
	SELECTCASE GET_STATE(CFLAG:(ARG:1):ステート)
		CASE "STONE","PALYZE","BIND","FREEZE","SHOCK","SLEEP","PANIC","CHARM","HEAT","SLIP"
			RETURN 1
	ENDSELECT
	IF (RAND:100 < ARG:2 * LOCAL / 100) || CFLAG:ARG:베어내기フラグ || HAVE_SKILL(ARG,[[스킬:푸린키피아]]) || HAVE_SKILL(ARG:1,[[스킬:푸린키피아]])
		RETURN 1
	ELSE
		RETURN 0
	ENDIF
;バステ影響설정有効無効(バニラ)
ELSE
	IF (RAND:100 < ARG:2 * LOCAL / 100) || CFLAG:ARG:베어내기フラグ || HAVE_SKILL(ARG,[[스킬:푸린키피아]]) || HAVE_SKILL(ARG:1,[[스킬:푸린키피아]])
		RETURN 1
	ELSE
		RETURN 0
	ENDIF
ENDIF

;기본的な魔法명중판정の処理
@JUDG_HIT_2,ARG,ARG:1,ARG:2
;ARG 공격者
;ARG:1 被공격者
;ARG:2 스킬명중률
;LOCAL 能力差による기본명중률
LOCAL = 80 - ((MAXBASE:(ARG:1):(GET_BATTLESTATUS(5)) + MAXBASE:(ARG:1):(GET_BATTLESTATUS(3))) / 2) + (MAXBASE:ARG:(GET_BATTLESTATUS(5)))
LOCAL *= (48 + CFLAG:ARG:명중강화 + CHECK_SKILL(ARG:1,2447)*4 + CHECK_SKILL(ARG:1,2448)*8)
LOCAL /= 48
LOCAL *= (48 - CFLAG:(ARG:1):회피강화)
LOCAL /= 48
;バステ影響설정有効
IF BATTLE_SETTING_IS_BAD_STATUS()
	SELECTCASE GET_STATE(CFLAG:(ARG:1):ステート)
		CASE "STONE","PALYZE","BIND","FREEZE","SHOCK","SLEEP","PANIC","CHARM","HEAT","SLIP"
			RETURN 1
	ENDSELECT
ENDIF
IF RAND:100 < ARG:2 * LOCAL / 100 || HAVE_SKILL(ARG,[[스킬:푸린키피아]]) || HAVE_SKILL(ARG:1,[[스킬:푸린키피아]])
	RETURN 1
ELSE
	RETURN 0
ENDIF


;기본的なバッド스테이터스부여の処理
@ATTACK_BADSTATE,ARG,ARG:1,ARG:2,ARG:3,ARG:4,ARG:5
;ARG 공격者
;ARG:1 被공격者
;ARG:2 バッド스테이터스の종류
;ARG:3 相性
;ARG:4 기본부여확률
;ARG:5 확률上限
;LOCAL 확률
;LOCA:1 掛かったフラグ

IF MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) <= 0 || MAXBASE:(ARG:1):GET_STATE(ARG:2) <= -100 || (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999 && !CFLAG:(ARG:1):(GET_TYPE(ARG:3)+"가드킬")) || (CFLAG:(ARG:1):물리반사フラグ && ARG:3 < 4) || (CFLAG:(ARG:1):마법반사フラグ && (ARG:3 > 3 && ARG:3 != 17)) || (CFLAG:(ARG:1):무효フラグ && ARG:3 != 17) || CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "웨이트")
	PRINTL BLOCK
	RETURN 0
ENDIF

LOCALS = %GET_STATE(ARG:2)%무효화횟수
IF CFLAG:(ARG:1):LOCALS
	PRINTL BLOCK
	CFLAG:(ARG:1):(GET_STATE(ARG:2) + "被弾") = 1
	RETURN 0
ENDIF

LOCALS = %GET_TYPE(ARG:3)%무효화횟수
IF CFLAG:(ARG:1):LOCALS
	PRINTL BLOCK
	CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "被弾") = 1
	RETURN 0
ENDIF

LOCALS = バステ무효화횟수
IF CFLAG:(ARG:1):LOCALS
	PRINTL BLOCK
	CFLAG:(ARG:1):バステ被弾 = 1
	RETURN 0
ENDIF

;방어中はバッド스테이터스にかからない
IF CFLAG:(ARG:1):방어フラグ == 1
	PRINTL GUARD
	RETURN 0
ENDIF


;LOCAL = ARG:4 * (MAXBASE:ARG:(GET_BATTLESTATUS(5)) + MAXBASE:ARG:(GET_BASESTATUS(6)) * 2) / (MAXBASE:(ARG:1):(GET_BATTLESTATUS(5)) + MAXBASE:(ARG:1):(GET_BASESTATUS(6)))
LOCAL = ARG:4 * MAX(1,(100 - MAXBASE:(ARG:1):(GET_BATTLESTATUS(5)) - MAXBASE:(ARG:1):(GET_BASESTATUS(6)) + MAXBASE:ARG:(GET_BATTLESTATUS(5))+ MAXBASE:ARG:(GET_BASESTATUS(6)))) / 100
LOCAL -= CFLAG:(ARG:1):마법효과강화
;呪い、낙인だと即死しやすい 即死내성관통
IF (CFLAG:(ARG:1):ステート == GET_STATE_NUM("CURSE") || CFLAG:(ARG:1):ステート == GET_STATE_NUM("BRAND")) && ARG:2 == GET_STATE_NUM("DYING")
	LOCAL += 50
ELSE
	;내성による보정
	LOCAL *= (100+MAXBASE:(ARG:1):GET_STATE(ARG:2))
	LOCAL /= 100
ENDIF

SIF CFLAG:(ARG:1):ボスフラグ
	LOCAL /= 4
SIF LOCAL > ARG:5
	LOCAL = ARG:5
CALL 相性소질체크, ARG, ARG:3, 1
SIF RESULT == 1
	LOCAL = LOCAL * 3/2
LOCAL:1 = 0
SIF RAND:100 < (LOCAL * MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) / 100) *(CFLAG:(ARG:1):BS付着率강화+4)/4
	LOCAL:1 = 1
SELECTCASE GET_STATE(ARG:2)
	CASE "STONE","DYING"
		SIF CFLAG:(ARG:1):ボスフラグ
			LOCAL:1 = 0
	CASE "FLY"
		SIF CFLAG:(ARG:1):PTフラグ < 1
			LOCAL:1 = 0
ENDSELECT
SIF CFLAG:(ARG:1):ステート > ARG:3
	LOCAL:1 = 0
IF LOCAL:1 == 0 || (CFLAG:(ARG:1):PTフラグ < 1 && CFLAG:(ARG:1):バステ무효フラグ)
	PRINTFORML \@ ((MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) != 999) && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) > 0)) ? Miss # BLOCK \@
	RETURN 0
ELSE
;---- EDIT 028 MOD START -------------------------
	IF CFLAG:(ARG:1):ステート == GET_STATE_NUM("FLY")
		CFLAG:(ARG:1):ステート = 0
		CALL SYNC_STATUS,ARG:1
	ENDIF
;---- EDIT 028 MOD END ---------------------------
	CFLAG:(ARG:1):ステート = ARG:2
	CFLAG:(ARG:1):ステート経過ターン = 0
	CALL ACTIONABLE_CHARA,ARG:1
	SIF RESULT == 0
		CFLAG:(ARG:1):입력行動 = -1
	PRINTFORML %GET_STATE(ARG:2)%
	SIF GET_STATE(ARG:2) == "DYING"
		CALL DEAD_CHARA,ARG:1
;---- EDIT 028 MOD START -------------------------
	SIF GET_STATE(ARG:2) == "FLY"
		CALL SYNC_STATUS,ARG:1
;---- EDIT 028 MOD END ---------------------------
	RETURN 1
ENDIF


;======================================================================
;전투不能処理
;======================================================================
@DEAD_CHARA,ARG
#DIM num
#LOCALSIZE 3
VARSET num,0
BASE:ARG:ＨＰ = 0
CFLAG:ARG:ステート = GET_STATE_NUM("DYING")
;---- EDIT 028 MOD START -------------------------
CALL SYNC_STATUS,ARG
;---- EDIT 028 MOD END ---------------------------
IF CFLAG:ARG:PTフラグ == 0
	PRINTL
	;仲魔に居る악마を倒すと混沌に傾く ストレージ内は考慮しないように변경
;	SIF CFLAG:(FINDCHARA(NO,NO:ARG)):PTフラグ > 0
	FOR LOCAL,0,CHARANUM
		IF NO:LOCAL == NO:ARG && (CFLAG:LOCAL:PTフラグ == 2 || (CFLAG:LOCAL:PTフラグ == 1 && CFLAG:LOCAL:所属ＣＯＭＰ != -1))
			CALL INCREASE_LC,-1
			BREAK
		ENDIF
	NEXT
	PRINTFORMW %조사처리(CALLNAME:ARG,"를")% 쓰러트렸다
	;悪魔解析度が5上昇
	CALL INCREASE_ANALYZE,NO:ARG,5
	SIF CFLAG:ARG:死体残存 == 0
		CALL REMOVE_POSITION,CFLAG:ARG:포지션
	CFLAG:ARG:입력行動 = -1
ELSE
	IF ARG == MASTER
		CFLAG:ARG:입력行動 = -1
		PRINTL
		PRINTFORMW %조사처리(CALLNAME:ARG,"는")% 힘이 다했다
		SIF TFLAG:킬링리액트
			num = num + 1
	ELSEIF ABL:ARG:종족 == 0 || ABL:ARG:종족 == 39 || NO:ARG == 4509 || CFLAG:ARG:所属ＣＯＭＰ == -1
		CFLAG:ARG:입력行動 = -1
		PRINTL
		PRINTFORMW %조사처리(CALLNAME:ARG,"는")% 힘이 다했다
		SIF TFLAG:킬링리액트
			num = num + 1
	ELSE
		IF FLAG:SHOPコマンド != 102 && CPOS(ARG) > 0 && CFLAG:ARG:所属ＣＯＭＰ != -1
			CALL REMOVE_POSITION,CFLAG:ARG:포지션
			CFLAG:ARG:입력行動 = -1
			PRINTL
			PRINTFORMW %조사처리(CALLNAME:ARG,"는")% 힘이 다해 ＣＯＭＰ로 돌아갔다
			SIF TFLAG:킬링리액트
				num = num + 1
		ELSE
			CFLAG:ARG:입력行動 = -1
			PRINTL
			PRINTFORMW %조사처리(CALLNAME:ARG,"는")% 힘이 다했다
			SIF TFLAG:킬링리액트
				num = num + 1
		ENDIF
	ENDIF
	;瀕死になった場合はCFLAG:던전内発情用욕정치が半分になり、発情상태が해제される
	IF FLAG:ムフフ전개 && CFLAG:ARG:던전内発情用욕정치
		CFLAG:ARG:던전内発情用욕정치 /= 2
		CFLAG:ARG:던전内発情 = 0
	ENDIF
ENDIF
IF num > 0
	FOR LOCAL:1, 7, 17
		SIF POS(LOCAL:1) == -1 || CFLAG:POS(LOCAL:1):ステート == GET_STATE_NUM("DYING")
			CONTINUE
		SIF NO:(POS(LOCAL:1)) == [[キャラ:니알라]]
			CALL SPECIAL_ACTION_3571,LOCAL:1
	NEXT
ENDIF


;===============================
;善悪操作
;==============================
@INCREASE_LD,ARG
CFLAG:MASTER:善悪치 += ARG
SIF CFLAG:MASTER:善悪치 > 255
	CFLAG:MASTER:善悪치 = 255
SIF CFLAG:MASTER:善悪치 < 0
	CFLAG:MASTER:善悪치 = 0
SELECTCASE FLAG:속성固定LD
	CASE 1
		CFLAG:MASTER:善悪치 = 255
	CASE 2
		CFLAG:MASTER:善悪치 = 127
	CASE 3
		CFLAG:MASTER:善悪치 = 0
ENDSELECT

@CHANGE_CHARA_LD,ARG,ARG:1,ARG:2
;ARGのキャラが、ARG:1に、ARG:2だけ近づく
IF CFLAG:ARG:善悪치 >= ARG:1
	CFLAG:ARG:善悪치 -= ARG:2
	SIF CFLAG:ARG:善悪치 < ARG:1
		CFLAG:ARG:善悪치 = ARG:1
ELSE
	CFLAG:ARG:善悪치 += ARG:2
	SIF CFLAG:ARG:善悪치 > ARG:1
		CFLAG:ARG:善悪치 = ARG:1
ENDIF
SIF CFLAG:ARG:善悪치 > 255
	CFLAG:ARG:善悪치 = 255
SIF CFLAG:ARG:善悪치 < 0
	CFLAG:ARG:善悪치 = 0
IF ARG == MASTER || ARG:1 == MASTER
	SELECTCASE FLAG:속성固定LD
		CASE 1
			CFLAG:MASTER:善悪치 = 255
		CASE 2
			CFLAG:MASTER:善悪치 = 127
		CASE 3
			CFLAG:MASTER:善悪치 = 0
	ENDSELECT
ENDIF

;===========================
;秩混操作
;==============================
@INCREASE_LC,ARG
CFLAG:MASTER:秩混치 += ARG
SIF CFLAG:MASTER:秩混치 > 255
	CFLAG:MASTER:秩混치 = 255
SIF CFLAG:MASTER:秩混치 < 0
	CFLAG:MASTER:秩混치 = 0
SELECTCASE FLAG:속성固定LC
	CASE 1
		CFLAG:MASTER:秩混치 = 255
	CASE 2
		CFLAG:MASTER:秩混치 = 127
	CASE 3
		CFLAG:MASTER:秩混치 = 0
ENDSELECT

@CHANGE_CHARA_LC,ARG,ARG:1,ARG:2
;ARGのキャラが、ARG:1に、ARG:2だけ近づく
IF CFLAG:ARG:秩混치 >= ARG:1
	CFLAG:ARG:秩混치 -= ARG:2
	SIF CFLAG:ARG:秩混치 < ARG:1
		CFLAG:ARG:秩混치 = ARG:1
ELSE
	CFLAG:ARG:秩混치 += ARG:2
	SIF CFLAG:ARG:秩混치 > ARG:1
		CFLAG:ARG:秩混치 = ARG:1
ENDIF
SIF CFLAG:ARG:秩混치 > 255
	CFLAG:ARG:秩混치 = 255
SIF CFLAG:ARG:秩混치 < 0
	CFLAG:ARG:秩混치 = 0
IF ARG == MASTER || ARG:1 == MASTER
	SELECTCASE FLAG:속성固定LC
		CASE 1
			CFLAG:MASTER:秩混치 = 255
		CASE 2
			CFLAG:MASTER:秩混치 = 127
		CASE 3
			CFLAG:MASTER:秩混치 = 0
	ENDSELECT
ENDIF

@ADJUST_CHARA_ALI,ARG
;いわゆる초기설정
IF CFLAG:ARG:善悪치 == 0
	IF ABL:ARG:속성LD == 1
		CFLAG:ARG:善悪치 = 255
	ELSEIF ABL:ARG:속성LD == 2
		CFLAG:ARG:善悪치 = 128
	ENDIF
ENDIF
IF CFLAG:ARG:秩混치 == 0
	IF ABL:ARG:속성LC == 1
		CFLAG:ARG:秩混치 = 255
	ELSEIF ABL:ARG:속성LC == 2
		CFLAG:ARG:秩混치 = 128
	ENDIF
ENDIF


;===============================
;MAG操作
;==============================
@CONTROL_MAG,ARG,ARG:1
IF BASE:ARG:ＭＡＧ + ARG:1 > MAXBASE:ARG:ＭＡＧ
	ARG:1 = MAXBASE:ARG:ＭＡＧ - BASE:ARG:ＭＡＧ
ELSEIF BASE:ARG:ＭＡＧ + ARG:1 < 0
	ARG:1 = -BASE:ARG:ＭＡＧ
ENDIF
BASE:ARG:ＭＡＧ += ARG:1
TCVAR:ARG:획득ＭＡＧ += ARG:1
;SIF BASE:ARG:ＭＡＧ > MAXBASE:ARG:ＭＡＧ
;	BASE:ARG:ＭＡＧ = MAXBASE:ARG:ＭＡＧ
;SIF BASE:ARG:ＭＡＧ < 0
;	BASE:ARG:ＭＡＧ = 0

;===============================
;MAG흡수
;==============================
@DRAIN_MAG,ARG,ARG:1,ARG:2
ARG:1 *= 2
IF TALENT:(ARG:2):영매체질 && TEQUIP:25 == 0
	ARG:1 *= 5
	SIF !TALENT:(ARG:2):비전투원
		ARG:1 /= 2
ENDIF

;相손のMAGが満タンの場合は経験値になる（割五鈷杵彫りの반지장비時のみ）
;1EXP = 10MAG、一回の最高値は次の레벨に필요な総経験地の20％
;『당신』の레벨の半分までしか上げられない
IF MAXBASE:(ARG:2):ＭＡＧ == BASE:(ARG:2):ＭＡＧ && (CFLAG:ARG:그외 == 1130 || CFLAG:ARG:그외2 == 1130 || CFLAG:ARG:그외3 == 1130)&&  BASE:(ARG:2):LV < BASE:ARG:LV / 2
	IF BASE:ARG:ＭＡＧ >= ARG:1
		BASE:(ARG:2):ＥＸＰ += LIMIT(ARG:1 / 10 , 0 , MAXBASE:(ARG:2):ＥＸＰ / 5)
		BASE:ARG:ＭＡＧ -= LIMIT(ARG:1 / 10 , 0 , MAXBASE:(ARG:2):ＥＸＰ / 5) * 10
	ELSEIF BASE:ARG:ＭＡＧ < ARG:1
		BASE:(ARG:2):ＥＸＰ += LIMIT(BASE:ARG:ＭＡＧ / 10 , 0 , MAXBASE:(ARG:2):ＥＸＰ / 5)
		BASE:ARG:ＭＡＧ = 0
	ENDIF
ENDIF

;MAGが溢れる事を防ぐ
SIF ARG:1 > (MAXBASE:(ARG:2):ＭＡＧ - BASE:(ARG:2):ＭＡＧ) && (TEQUIP:25 == 0 || FLAG:촉수신사각성 == 0)
	ARG:1 = (MAXBASE:(ARG:2):ＭＡＧ - BASE:(ARG:2):ＭＡＧ)
SIF BASE:ARG:ＭＡＧ < ARG:1
	ARG:1 = BASE:ARG:ＭＡＧ
IF TEQUIP:25 && FLAG:촉수신사각성
	CALL CONTROL_MAG,ARG,-ARG:1
	FLAG:촉수エネルギー += ARG:1 * (10 + ABL:ARG:촉수중독 * 9) / 100
	SIF FLAG:촉수エネルギー > MAXBASE:MASTER:ＭＡＧ
		FLAG:촉수エネルギー = MAXBASE:MASTER:ＭＡＧ
	;PRINTFORML 촉수エネルギー +{(ARG:1 * (10 + ABL:ARG:촉수중독 * 9) / 100)}
	;PRINTFORML %NAME:ARG%:ＭＡＧ -{ARG:1}
	RETURN ARG:1
ELSE
	CALL CONTROL_MAG,ARG,-ARG:1
	CALL CONTROL_MAG,ARG:2,ARG:1
	;PRINTFORML %NAME:(ARG:2)%:ＭＡＧ +{ARG:1}
	;PRINTFORML %NAME:ARG%:ＭＡＧ -{ARG:1}
	RETURN ARG:1
ENDIF


;====================================================
;DEVIL_COOP
;====================================================
@DEVIL_COOP,ARG
#LOCALSIZE 11
;COOPを行う필요があるかの판정
;LOCAL:5 = 受ける人数
LOCAL:5 = 0

IF CFLAG:ARG:PTフラグ == 0
	LOCAL:7 = 1
	LOCAL:8 = 7
ELSE
	LOCAL:7 = 7
	LOCAL:8 = 17
ENDIF


FOR LOCAL,LOCAL:7,LOCAL:8
	LOCALS = 포지션{LOCAL}
	SIF FLAG:LOCALS > -1 && GET_STATE(CFLAG:(FLAG:LOCALS):ステート) != "DYING" && CFLAG:(FLAG:LOCALS):ＣＯＯＰフラグ
		LOCAL:5 += 1
NEXT

SIF LOCAL:5 == 0
	RETURN 0


;ARG = 発動させたキャラ
LOCAL:2 = 0
;LOCAL:2 = 참가人数
;LOCAL:3 = COOP威힘
LOCAL:3 = 50
;LOCAL:4 = COOP공격힘
LOCAL:4 = 0
;LOCAL:5 = 공격側の平均ＬＶ　＊再利用
;LOCAL:6 = ダメージ値
;참가人数を割り出す
IF CFLAG:ARG:PTフラグ == 0
	LOCAL:7 = 7
	LOCAL:8 = 17
ELSE
	LOCAL:7 = 1
	LOCAL:8 = 7
ENDIF
FOR LOCAL,LOCAL:7,LOCAL:8
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		CALL COOPABLE_CHARA,FLAG:LOCALS
		SIF RESULT == 0
			CONTINUE
		IF FLAG:LOCALS == ARG && CFLAG:ARG:ボスフラグ == 0
			LOCAL:2 += 1
			LOCAL:4 += MAX(MAXBASE:(FLAG:LOCALS):공격 , MAXBASE:(FLAG:LOCALS):마법위력)
			LOCAL:5 += MAXBASE:(FLAG:LOCALS):LV
			CFLAG:(FLAG:LOCALS):ＣＯＯＰ참가フラグ = 1
			CONTINUE
		ENDIF
		;LOCAL:9 = 個別のCOOP威힘加算値
		;기본COOP加算 110%
		IF (ABL:(FLAG:LOCALS):속성LD == ABL:ARG:속성LD && ABL:(FLAG:LOCALS):속성LC == ABL:ARG:속성LC) || (EQUIP:MASTER:ＣＯ－ＯＰ강화C && GET_SUMMONER_LV2() > 2 && (함락(FLAG:LOCALS, ARG) > 1 || 함락(ARG, FLAG:LOCALS) > 1)) || 특별우정確認(ARG,FLAG:LOCALS)
			;페르소나EXPの加算
			CALL INCREASE_PERSONA_EXP, FLAG:LOCALS, 1, 30
			LOCAL:2 += 1
			LOCAL:9 = 110
			IF FLAG:LOCALS == ARG && CFLAG:ARG:ボスフラグ
				LOCAL:2 += 1
				LOCAL:9 += 40
			ENDIF
			LOCAL:4 += MAX(MAXBASE:(FLAG:LOCALS):공격 , MAXBASE:(FLAG:LOCALS):마법위력)
			LOCAL:5 += MAXBASE:(FLAG:LOCALS):LV
			CFLAG:(FLAG:LOCALS):ＣＯＯＰ참가フラグ = 1
		;기본COOP威힘加算 60%
		ELSEIF ABL:(FLAG:LOCALS):속성LD == ABL:ARG:속성LD || ABL:(FLAG:LOCALS):속성LC == ABL:ARG:속성LC
			;페르소나EXPの加算
			CALL INCREASE_PERSONA_EXP, FLAG:LOCALS, 1, 30
			LOCAL:9 = 60
			SIF EQUIP:MASTER:ＣＯ－ＯＰ강화W && GET_SUMMONER_LV2() > 2
				LOCAL:9 += 50
			LOCAL:2 += 1
			LOCAL:4 += MAX(MAXBASE:(FLAG:LOCALS):공격 , MAXBASE:(FLAG:LOCALS):마법위력)
			LOCAL:5 += MAXBASE:(FLAG:LOCALS):LV
			CFLAG:(FLAG:LOCALS):ＣＯＯＰ참가フラグ = 1
		;기본COOP威힘加算 60%
		ELSEIF EQUIP:MASTER:ＣＯ－ＯＰ강화C && GET_SUMMONER_LV2() > 2 && (함락(FLAG:LOCALS, ARG)||함락(ARG, FLAG:LOCALS))
			;페르소나EXPの加算
			CALL INCREASE_PERSONA_EXP, FLAG:LOCALS, 1, 30
			LOCAL:9 = 60
			LOCAL:2 += 1
			LOCAL:4 += MAX(MAXBASE:(FLAG:LOCALS):공격 , MAXBASE:(FLAG:LOCALS):마법위력)
			LOCAL:5 += MAXBASE:(FLAG:LOCALS):LV
			CFLAG:(FLAG:LOCALS):ＣＯＯＰ참가フラグ = 1
		ELSE
			CONTINUE
		ENDIF
		;추격의심득持ちは威힘が1.5倍
		SIF HAVE_SKILL(FLAG:LOCALS,[[스킬:추격의심득]])
			TIMES LOCAL:9, 1.50
		;ALI보정を抜いた相性と함락によって1%〜150%の보정が発生する
		LOCAL:10 = GET_RELATION(FLAG:LOCALS, ARG , 0)
		IF 함락(FLAG:LOCALS, ARG) == 1
			LOCAL:10 += 10
		ELSE
			LOCAL:10 += 함락(FLAG:LOCALS, ARG) * 25
		ENDIF
		LOCAL:10 = LIMIT(LOCAL:10, 1, 200)
		LOCAL:10 = LOCAL:10 > 100 ? (LOCAL:10 - 100) / 2 + 100 # LOCAL:10
		LOCAL:9 = LOCAL:9 * LOCAL:10 / 100
		;합계COOP威힘に個別COOP威힘を加算
		LOCAL:3 += LOCAL:9
	ENDIF
NEXT
SIF LOCAL:2 < 2
	RETURN 0
;LOCAL:3 += (LOCAL:2 - 1) * 60
LOCAL:4 /= LOCAL:2
LOCAL:5 /= LOCAL:2
;DEVIL_COOP発動
;ＣＯＯＰを引き起こした페르소나구사자の페르소나経験値を人数分増加
;ただし、自分참가で1点入るのでここでは1引いとく
SIF CFLAG:ARG:PTフラグ > 0
	CALL INCREASE_PERSONA_EXP, ARG, LOCAL:2 - 1, 31
IF CFLAG:ARG:PTフラグ == 0
	SETCOLOR 0xff0033
ELSE
	SETCOLOR 0x33ffcc
ENDIF
IF FLAG:RPG구상 == 0
	;구상用にTARGET保存
	LOCAL:9 = TARGET
	TARGET = ARG
	;COOP発動時구상
	TFLAG:전투이벤트 = 1
	IF CFLAG:ARG:PTフラグ == 0
		CALL 구상呼び出し , "ENEMY_BATTLE_EVENT" , ARG , ARG
	ELSE
		CALL 구상呼び出し , "BATTLE_EVENT" , ARG , ARG
	ENDIF
	TARGET = LOCAL:9
ENDIF
;참가者の표시・新記述版
ALIGNMENT CENTER
PRINTFORML ┏━━━━━━━━━━━━━━━━━┓
PRINTFORML ┃   ＤＥＶＩＬ ＣＯ－ＯＰ 발동！   ┃
PRINTFORML ┗━━━━━━━━━━━━━━━━━┛
FOR LOCAL,0,2
	FOR LOCAL:10,LOCAL:7,(LOCAL:8 - LOCAL:7) / 2 + 1
		IF POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) > -1 && (CFLAG:POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10):ＣＯＯＰ참가フラグ || POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) == ARG)
			PRINTFORM ┏━━━━━━━━━━┓
		ELSE
			SETCOLOR 0x404040
			PRINTFORM ┏━━━━━━━━━━┓
			IF CFLAG:ARG:PTフラグ == 0
				SETCOLOR 0xff0033
			ELSE
				SETCOLOR 0x33ffcc
			ENDIF
		ENDIF
		SIF LOCAL:10 != (LOCAL:8 - LOCAL:7)/2
			PRINTFORM 　
	NEXT
	PRINTL
	FOR LOCAL:10,LOCAL:7,(LOCAL:8 - LOCAL:7) / 2 + 1
		IF POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) > -1 && (CFLAG:POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10):ＣＯＯＰ참가フラグ || POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) == ARG)
			PRINTFORM ┃%CALLNAME:POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10),20,LEFT%┃
		ELSE
			SETCOLOR 0x404040
			PRINTFORM ┃\@ POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) > -1 ? %CALLNAME:POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10),20,LEFT% # %"ＥＭＰＴＹ",20,LEFT%\@┃
			IF CFLAG:ARG:PTフラグ == 0
				SETCOLOR 0xff0033
			ELSE
				SETCOLOR 0x33ffcc
			ENDIF
		ENDIF
		SIF LOCAL:10 != (LOCAL:8 - LOCAL:7)/2
			PRINTFORM 　
	NEXT
	PRINTL
	FOR LOCAL:10,LOCAL:7,(LOCAL:8 - LOCAL:7) / 2 + 1
		IF POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) > -1 && (CFLAG:POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10):ＣＯＯＰ참가フラグ || POS(LOCAL*(LOCAL:8 - LOCAL:7) / 2+LOCAL:10) == ARG)
			PRINTFORM ┗━━━━━━━━━━┛
		ELSE
			SETCOLOR 0x404040
			PRINTFORM ┗━━━━━━━━━━┛
			IF CFLAG:ARG:PTフラグ == 0
				SETCOLOR 0xff0033
			ELSE
				SETCOLOR 0x33ffcc
			ENDIF
		ENDIF
		SIF LOCAL:10 != (LOCAL:8 - LOCAL:7)/2
			PRINTFORM 　
	NEXT
	PRINTL
NEXT
PRINTFORML ┏━━━━━━━━┓
PRINTFORML ┃ＰＯＷＥＲ:{LOCAL:3 * 100 / 600,3}％┃
PRINTFORML ┗━━━━━━━━┛
ALIGNMENT LEFT
;新記述版ここまで
FOR LOCAL,LOCAL:7,LOCAL:8
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		SIF CFLAG:(FLAG:LOCALS):ＣＯＯＰ참가フラグ == 0
			CONTINUE
		SIF FLAG:LOCALS != MASTER
			TCVAR:(FLAG:LOCALS):획득충성도 += 20
			;BASE:(FLAG:LOCALS):충성도 += 20
;---- EDIT 020 ADD START -------------------------
		IF FLAG:ムフフ전개 && EQUIP:MASTER:엑스링케이지
			;ＣＯＯＰ참가した仲間の던전内発情用욕정치が욕정と새드끼に応じて増加
			CFLAG:(FLAG:LOCALS):던전内発情用욕정치 += 25 * (ABL:(FLAG:LOCALS):욕망 + ABL:(FLAG:LOCALS):새드끼 ) + 250
		ENDIF
;---- EDIT 020 ADD START -------------------------
		;ＣＯＯＰ참가した악마の解析度+20
		IF CFLAG:(FLAG:LOCALS):PTフラグ > 0
			CALL INCREASE_ANALYZE,NO:(FLAG:LOCALS),20
		ENDIF
		TFLAG:전투이벤트 = 0
		;참가者표시：旧記述版
;		PRINTFORML ┏━━━━━━━━━━━━━┓　┏━━━━━━━━━━━━━━━━━━━━┓
;		PRINTFORML ┃[{CFLAG:(FLAG:LOCALS):포지션,2}] %CALLNAME:(FLAG:LOCALS),21,LEFT%┃　┃          데빌ＣＯ－ＯＰ 발동！         ┃
;		PRINTFORML ┗━━━━━━━━━━━━━┛　┗━━━━━━━━━━━━━━━━━━━━┛
		IF FLAG:RPG구상 == 0 && FLAG:LOCALS != ARG
			TFLAG:전투이벤트 = 2
			LOCAL:9 = TARGET
			TARGET = FLAG:LOCALS
			IF CFLAG:ARG:PTフラグ == 0
				CALL 구상呼び出し , "ENEMY_BATTLE_EVENT" , FLAG:LOCALS , FLAG:LOCALS
			ELSE
				CALL 구상呼び出し , "BATTLE_EVENT" , FLAG:LOCALS , FLAG:LOCALS
			ENDIF
			TARGET = LOCAL:9
			TFLAG:전투이벤트 = 0
		ENDIF
	ENDIF
NEXT
RESETCOLOR
WAIT


IF CFLAG:ARG:PTフラグ == 0
	LOCAL:7 = 1
	LOCAL:8 = 7
ELSE
	LOCAL:7 = 7
	LOCAL:8 = 17
ENDIF

FOR LOCAL,LOCAL:7,LOCAL:8
	LOCALS = 포지션{LOCAL}
	IF FLAG:LOCALS > -1
		SIF CFLAG:(FLAG:LOCALS):ＣＯＯＰフラグ == 0
			CONTINUE
		IF CFLAG:(FLAG:LOCALS):PTフラグ == 0
			CALL INCREASE_ANALYZE,NO:(FLAG:LOCALS),LIMIT((LOCAL:3 * 10 / 6),20,100)
		ENDIF
		PRINTFORM 　　TARGET:[{CPOS(FLAG:LOCALS),2}] %CALLNAME:(FLAG:LOCALS),20,LEFT%　>>>>>>　
				
;		LOCAL:6 = CFLAG:(FLAG:LOCALS):ＣＯＯＰフラグ * LOCAL:3 * LOCAL:4 * (LOCAL:4/4+4) / ((MAXBASE:(FLAG:LOCALS):방어 + MAXBASE:(FLAG:LOCALS):마법효과) * 50) * 3 / 2 / 100
		LOCAL:6 = (50 + LOCAL:5*5/2)+CFLAG:(FLAG:LOCALS):ＣＯＯＰフラグ
		LOCAL:6 *= (100+LOCAL:5)*(LOCAL:4)*(10+LOCAL:4/12) * LOCAL:3
		LOCAL:6 /= ((MAXBASE:(FLAG:LOCALS):방어 + MAXBASE:(FLAG:LOCALS):마법효과)/2) * 100 * 100 * 300


		LOCAL:6 *= (32 + CFLAG:ARG:공격강화) + (32 + CFLAG:ARG:마법위력강화)
		LOCAL:6 /= 64
		LOCAL:6 *= (32 - CFLAG:(FLAG:LOCALS):방어강화) + (32 - CFLAG:(FLAG:LOCALS):마법효과강화)
		LOCAL:6 /= 64
		;乱数
		LOCAL:6 *= (9500+RAND:1000)
		LOCAL:6 /= 10000

		;방어中のキャラにはダメージ減少
		SIF CFLAG:(FLAG:LOCALS):방어フラグ
			LOCAL:6 /= 2
		;後列のキャラへのダメージ減少はない
		;受ける側が아군の場合難易度修正
		IF CFLAG:(FLAG:LOCALS):PTフラグ > 0
			SELECTCASE FLAG:4
				CASE 1
					TIMES LOCAL:6,0.75
				CASE 3
					TIMES LOCAL:6,1.5
			ENDSELECT
		ENDIF
		IF CFLAG:(FLAG:LOCALS):PTフラグ > 0
			SELECTCASE FLAG:전투난이도
				CASE 1
					TIMES LOCAL:6 , 0.75
				CASE 3,4
					TIMES LOCAL:6 , 1.5
				CASE 5
					TIMES LOCAL:6 , 2
				CASE 6
					TIMES LOCAL:6 , 3
			ENDSELECT
		ENDIF
		;眠っていたらダメージ大
		SIF CFLAG:(FLAG:LOCALS):ステート == GET_STATE_NUM("SLEEP")
			TIMES LOCAL:6,1.5
		;特殊보정
		LOCAL:6 = LOCAL:6 * (CFLAG:(FLAG:LOCALS):COOP被데미지보정 +100) / 100
		;ハント스킬보정
		TRYCCALLFORM ハント스킬_{CFLAG:ARG:입력行動}
			LOCAL:6 = LOCAL:6 * RESULT / 100
		CATCH
		ENDCATCH
		IF LOCAL:6 >= BASE:(FLAG:LOCALS):ＨＰ && HAVE_SKILL(FLAG:LOCALS,2407) && CFLAG:(FLAG:LOCALS):이악물기フラグ == 0
			PRINTFORM {LOCAL:6}데미지
			CALL VAR_HP,FLAG:LOCALS,-LOCAL:6,2
			CFLAG:(FLAG:LOCALS):이악물기フラグ = 1
		ELSEIF LOCAL:6 >= BASE:(FLAG:LOCALS):ＨＰ && HAVE_SKILL(FLAG:LOCALS,[[스킬:네버기브업]]) && CFLAG:(FLAG:LOCALS):이악물기フラグ == 0
			PRINTFORM {LOCAL:6}데미지
			CALL VAR_HP,FLAG:LOCALS,-LOCAL:6,2
			CFLAG:(FLAG:LOCALS):이악물기フラグ = 1
		ELSEIF LOCAL:6 >= BASE:(FLAG:LOCALS):ＨＰ && HAVE_SKILL(FLAG:LOCALS,2406) && CFLAG:(FLAG:LOCALS):이악물기フラグ == 0
			PRINTFORM {LOCAL:6}데미지
			CALL VAR_HP,FLAG:LOCALS,-LOCAL:6,1
			CFLAG:(FLAG:LOCALS):이악물기フラグ = 1
		ELSEIF LOCAL:6 >= 0
			PRINTFORM {LOCAL:6}데미지
			CALL VAR_HP,FLAG:LOCALS,-LOCAL:6,0
		ENDIF
		SIF FLAG:LOCALS > -1 && CFLAG:(FLAG:LOCALS):ステート == GET_STATE_NUM("SLEEP")
			CFLAG:(FLAG:LOCALS):ステート = 0
		;ダメージを受け、死亡しており、ハント스킬を使われていた場合は被ハントフラグを立てておく
		IF FLAG:LOCALS > -1 && LOCAL:6 > 0 && CFLAG:(FLAG:LOCALS):ステート == GET_STATE_NUM("DYING")
			TRYCCALLFORM ハント스킬_{CFLAG:ARG:입력行動}
				CFLAG:(FLAG:LOCALS):被ハント = ARG + 1
			CATCH
			ENDCATCH
		ENDIF
		PRINTL
	ENDIF
NEXT
WAIT

;=======================================================
;追撃可能かの판정
;====================================================
@COOPABLE_CHARA,ARG
SELECTCASE GET_STATE(CFLAG:ARG:ステート)
	CASE "DYING","STONE","PALYZE","BIND","FREEZE","SHOCK","SLEEP","PANIC","CHARM","HEAT","SLIP"
	;死んでると駄눈
	;石になってると駄눈
	;麻痺してると駄눈
	;金縛りだと駄눈
	;凍ってると駄눈
	;感電してると駄눈
	;眠ってるとダメ
	;魅了されてるとダメ
	;混乱してるとダメ
	;オーバー히트でダメ
	;転倒してると駄눈
		RETURN 0
ENDSELECT

RETURN 1


;=======================================================
;적の1more値をダウンさせる
;대상者	ARG
;減少値	ARG:1
;====================================================
@ONE_MORE_POINT_DOWN,ARG,ARG:1
SIF CFLAG:ARG:ボスフラグ
	ARG:1 = 1
CFLAG:ARG:１moreフラグ -= ARG:1


;=======================================================
;특별우정確認
;대상者 	ARG
;대상者2	ARG:1
;====================================================
@특별우정確認,ARG,ARG:1,ARG:2 = 0
#FUNCTION
SIF ARG < 1 && ARG >= CHARANUM
	RETURNF 0
SIF ARG:1 < 1 && ARG:1 >= CHARANUM
	RETURNF 0
SIF !(ABL:ARG:종족 == 0 || ABL:ARG:종족 == 36)
	RETURNF 0
SIF !(ABL:(ARG:1):종족 == 0 || ABL:(ARG:1):종족 == 36)
	RETURNF 0
FOR LOCAL,1750,1780
	SIF CFLAG:ARG:LOCAL == NO:(ARG:1) && ARG:2 != 2
		RETURNF 1
	SIF CFLAG:(ARG:1):LOCAL == NO:ARG && ARG:2 != 1
		RETURNF 1
NEXT
RETURNF 0
;=======================================================
;특별우정추가
;대상者 	ARG
;대상者2	ARG:1
;====================================================
@특별우정추가,ARG,ARG:1
SIF ARG < 1 && ARG >= CHARANUM
	RETURN
SIF ARG:1 < 1 && ARG:1 >= CHARANUM
	RETURN
SIF !(ABL:ARG:종족 == 0 || ABL:ARG:종족 == 36)
	RETURN
SIF !(ABL:(ARG:1):종족 == 0 || ABL:(ARG:1):종족 == 36)
	RETURN
IF !특별우정確認(ARG,ARG:1,1)
	FOR LOCAL,1760,1780
		IF CFLAG:ARG:LOCAL < 1
			CFLAG:ARG:LOCAL = NO:(ARG:1)
			BREAK
		ENDIF
	NEXT
ENDIF
IF !특별우정確認(ARG,ARG:1,2)
	FOR LOCAL,1760,1780
		IF CFLAG:(ARG:1):LOCAL < 1
			CFLAG:(ARG:1):LOCAL = NO:ARG
			BREAK
		ENDIF
	NEXT
ENDIF

